<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi POS Sederhana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for graphs in financial report -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2e8f0; /* Light gray background for the whole page */
            transition: background-color 0.3s ease; /* Transisi untuk mode gelap/terang */
            position: relative; /* Needed for absolute positioning of dark mode button */
        }
        /* Custom styles for rounded corners on all elements */
        .rounded-xl, .rounded-lg, .rounded-md {
            border-radius: 0.75rem; /* Equivalent to Tailwind's rounded-xl */
        }
        .rounded-t-lg {
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .transition-transform {
            transition-property: transform;
            transition-duration: 0.3s;
            transition-timing-function: ease-out;
        }
        .hover\:scale-105:hover {
            transform: scale(1.05);
        }
        /* Style to prevent body scrolling when modal is open */
        body.overflow-hidden {
            overflow: hidden;
        }
        /* Flex container for input and copy button */
        .input-with-copy {
            display: flex;
            align-items: center;
        }
        .input-with-copy input {
            flex-grow: 1;
        }
        .copy-button {
            margin-left: 0.5rem;
            padding: 0.5rem 0.75rem;
            background-color: #4A90E2; /* Blue */
            color: white;
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.2s;
            font-size: 0.875rem;
            line-height: 1;
        }
        .copy-button:hover {
            background-color: #357ABD; /* Darker Blue */
        }
        /* Styles for active/inactive tabs */
        .tab-button {
            @apply px-4 py-2 text-sm font-semibold rounded-t-lg;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; /* Add transition */
        }

        .tab-button.active-cashier {
            @apply bg-blue-600 text-white;
        }
        .tab-button.inactive-cashier {
            @apply bg-transparent text-blue-800 hover:bg-blue-100 hover:border-b-2 hover:border-blue-600;
        }
        .tab-button.active-custom-cashier {
            @apply bg-red-600 text-white;
        }
        .tab-button.inactive-custom-cashier {
            @apply bg-transparent text-red-800 hover:bg-red-100 hover:border-b-2 hover:border-red-600;
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        .dark-mode #login-screen .bg-white,
        .dark-mode #main-app-container .bg-gray-50,
        .dark-mode #main-app-container main .bg-gray-50,
        .dark-mode .bg-gray-50,
        .dark-mode .bg-white,
        .dark-mode .modal-content, /* Untuk semua modal */
        .dark-mode .bg-gray-100 { /* Untuk input di login/modal */
            background-color: #2d3748; /* Darker shades for elements */
            color: #e2e8f0;
        }
        .dark-mode #login-screen input,
        .dark-mode #main-app-container input,
        .dark-mode #main-app-container select,
        .dark-mode .border-gray-300,
        .dark-mode .border-gray-200 {
            border-color: #4a5568;
            background-color: #4a5568; /* Darker input backgrounds */
            color: #e2e8f0;
        }
        .dark-mode .text-gray-700,
        .dark-mode .text-gray-800,
        .dark-mode .text-gray-900 {
            color: #e2e8f0;
        }
        .dark-mode .text-gray-500 {
            color: #a0aec0;
        }
        .dark-mode #main-app-container header .bg-green-600 {
            background-color: #2f855a; /* Darker green for header */
        }
        .dark-mode #admin-menu-toggle {
            background-color: #2d3748;
            color: #e2e8f0;
            border-color: #4a5568;
        }
        .dark-mode #admin-menu-dropdown {
            background-color: #2d3748;
            border-color: #4a5568;
        }
        .dark-mode #admin-menu-dropdown button {
            color: #e2e8f0;
        }
        .dark-mode #admin-menu-dropdown button:hover {
            background-color: #4a5568;
        }
        /* Specific dark mode adjustments for elements with shadows */
        .dark-mode .shadow-lg, .dark-mode .shadow-md, .dark-mode .shadow-sm {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
        }
        .dark-mode .bg-gray-100 { /* For read-only/disabled inputs */
            background-color: #4a5568;
        }
    </style>
</head>
<body class="p-4 lg:p-8 flex items-center justify-center min-h-screen">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm text-center">
            <h2 class="text-3xl font-bold text-green-700 mb-8">بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيْمِ</h2>
            <div class="mb-4">
                <label for="login-username" class="block text-gray-700 text-sm font-medium mb-2 text-left">Nama Pengguna:</label>
                <input type="text" id="login-username" placeholder="Masukkan nama pengguna"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200">
            </div>
            <div class="mb-6">
                <label for="login-password" class="block text-gray-700 text-sm font-medium mb-2 text-left">Kata Sandi:</label>
                <input type="password" id="login-password" placeholder="Masukkan kata sandi"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200">
            </div>
            <button id="login-btn"
                    class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105 w-full">
                Login
            </button>
            <div id="login-message" class="mt-4 p-3 bg-red-100 border border-red-200 text-red-800 rounded-md hidden"></div>
        </div>
    </div>

    <!-- Toggle Dark/Light Mode Button - Moved outside main-app-container -->
    <button id="toggle-dark-mode" class="fixed top-4 right-4 text-gray-600 dark:text-white hover:text-gray-800 dark:hover:text-gray-200 focus:outline-none text-xl z-50">
        <i class="fas fa-lightbulb"></i>
    </button>

    <!-- Main Application Container -->
    <div id="main-app-container" class="container mx-auto p-4 lg:p-8 bg-gray-50 rounded-xl shadow-lg my-8 flex flex-col hidden">
        <header class="flex flex-col lg:flex-row justify-between items-center bg-green-600 text-white p-6 rounded-t-lg shadow-md relative">
            <h1 class="text-3xl lg:text-4xl font-bold mb-3 lg:mb-0"><b><i>UNIX</i></b></h1>
            <div class="flex-grow flex flex-col lg:flex-row lg:justify-end items-center lg:items-end gap-4 mt-4 lg:mt-0">
                <div class="text-sm opacity-90 text-center lg:text-right">
                    <span id="cashier-name" class="block">Kasir: Nama Kasir</span>
                    <span id="current-date" class="block">Tanggal: 17 Juni 2025</span>
                </div>
                <!-- Eye Icon for Hiding/Showing Today's Sales - Moved next to RP -->
                <div class="text-right text-xl font-bold mt-2 lg:mt-0 lg:ml-auto flex items-center gap-2">
                    <span id="today-sales-main-screen" class="block text-3xl">Rp 0</span>
                    <button id="toggle-sales-visibility" class="text-white hover:text-gray-200 focus:outline-none text-xl">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <nav class="mt-4 lg:mt-0 flex gap-4">
                    <button id="open-transaction-history-modal-btn"
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition duration-200 shadow-sm hover:scale-105">
                        Riwayat Transaksi
                    </button>
                    <div class="relative inline-block text-left" id="admin-menu-container">
                        <button type="button" id="admin-menu-toggle" class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 focus:ring-green-500 hover:scale-105 transition-transform" aria-expanded="true" aria-haspopup="true">
                            Menu Admin
                            <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 011.414 1.414l-4 4a1 1 01-1.414 0l-4-4a1 1 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div id="admin-menu-dropdown" class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-50" role="menu" aria-orientation="vertical" aria-labelledby="menu-button" tabindex="-1">
                            <div class="py-1" role="none">
                                <button id="open-price-calculator-btn" class="text-gray-700 block px-4 py-2 text-sm w-full text-left hover:bg-gray-100" role="menuitem" tabindex="-1">FIX PRICE</button>
                                <button id="open-expenses-modal-btn" class="text-gray-700 block px-4 py-2 text-sm w-full text-left hover:bg-gray-100" role="menuitem" tabindex="-1">Pengeluaran</button>
                                <button id="open-user-settings-modal-btn" class="text-gray-700 block px-4 py-2 text-sm w-full text-left hover:bg-gray-100" role="menuitem" tabindex="-1">Pengaturan Pengguna</button>
                                <button id="open-financial-report-modal-btn" class="text-gray-700 block px-4 py-2 text-sm w-full text-left hover:bg-gray-100" role="menuitem" tabindex="-1">Laporan Keuangan</button>
                                <button id="open-add-product-modal-btn" class="text-gray-700 block px-4 py-2 text-sm w-full text-left hover:bg-gray-100" role="menuitem" tabindex="-1">Tambah Produk Baru</button>
                                <button id="open-store-products-modal-btn" class="text-gray-700 block px-4 py-2 text-sm w-full text-left hover:bg-gray-100" role="menuitem" tabindex="-1">Produk Toko</button>
                                <hr class="my-1 border-gray-200">
                                <button id="export-products-btn" class="text-green-700 block px-4 py-2 text-sm w-full text-left hover:bg-gray-100 font-semibold" role="menuitem" tabindex="-1">Ekspor Produk</button>
                                <input type="file" id="import-products-file-input" accept=".json" class="hidden">
                                <button id="import-products-btn" class="text-blue-700 block px-4 py-2 text-sm w-full text-left hover:bg-gray-100 font-semibold" role="menuitem" tabindex="-1">Impor Produk</button>
                                <hr class="my-1 border-gray-200">
                                <button id="export-data-btn" class="text-green-700 block px-4 py-2 text-sm w-full text-left hover:bg-gray-100 font-semibold" role="menuitem" tabindex="-1">Ekspor Data Aplikasi Lengkap</button>
                                <input type="file" id="import-file-input" accept=".json" class="hidden">
                                <button id="import-data-btn" class="text-blue-700 block px-4 py-2 text-sm w-full text-left hover:bg-gray-100 font-semibold" role="menuitem" tabindex="-1">Impor Data Aplikasi Lengpat</button>
                                <hr class="my-1 border-1 border-gray-200">
                                <button id="reset-all-data-btn" class="text-red-600 block px-4 py-2 text-sm w-full text-left hover:bg-red-100 font-semibold" role="menuitem" tabindex="-1">Reset Semua Data</button>
                            </div>
                        </div>
                    </div>
                    <button id="logout-btn"
                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition duration-200 shadow-sm hover:scale-105">
                        Logout
                    </button>
                </nav>
            </div>
        </header>

        <main class="flex-grow p-6 bg-white rounded-b-lg flex flex-col lg:flex-row gap-6">
            <!-- Input Produk Section (TABS) -->
            <section class="lg:w-1/2 bg-gray-50 p-6 rounded-lg shadow-md flex flex-col">
                <!-- Tabs for Product Input -->
                <div class="flex gap-6 mb-4 border-b border-gray-200">
                    <!-- Changed button names and added specific color classes -->
                    <button id="tab-registered-product" class="tab-button active-cashier">Cashier</button>
                    <button id="tab-custom-product" class="tab-button inactive-custom-cashier">Custom Cashier</button>
                </div>

                <!-- Registered Product Input Area -->
                <div id="registered-product-input-area">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6 pb-3 border-b-2 border-gray-200">Cashier</h2>

                    <div class="mb-4">
                        <label for="product-code" class="block text-gray-700 text-sm font-medium mb-2">Kode Produk (Opsional):</label>
                        <div class="flex">
                            <input type="text" id="product-code" placeholder="Scan atau ketik kode produk"
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="product-name" class="block text-gray-700 text-sm font-medium mb-2">Nama Produk (Otomatis):</label>
                        <input type="text" id="product-name" readonly disabled
                            class="w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed text-gray-800" placeholder="Nama produk akan muncul di sini">
                    </div>

                    <div class="mb-4">
                        <label for="price" class="block text-gray-700 text-sm font-medium mb-2">Harga:</label>
                        <input type="text" id="price" placeholder="Harga akan muncul di sini" value="0" readonly disabled
                            class="w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed text-gray-800">
                    </div>

                    <div class="mb-6">
                        <label for="quantity" class="block text-gray-700 text-sm font-medium mb-2">Jumlah:</label>
                        <input type="number" id="quantity" value="1" min="1"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200">
                    </div>

                    <button id="add-to-cart-btn-registered" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105 w-full mb-6">
                        Tambahkan ke Keranjang (Terdaftar)
                    </button>
                </div>

                <!-- Custom Product Input Area (Hidden by default) -->
                <div id="custom-product-input-area" class="hidden">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6 pb-3 border-b-2 border-gray-200">Custom Cashier</h2>

                    <div class="mb-4">
                        <label for="custom-product-code" class="block text-gray-700 text-sm font-medium mb-2">Kode Produk Kustom (Opsional):</label>
                        <input type="text" id="custom-product-code" placeholder="Kode unik produk kustom (misal: CUST001)"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200">
                        <p class="text-xs text-gray-500 mt-1">Tidak boleh sama dengan kode produk terdaftar.</p>
                    </div>

                    <div class="mb-4">
                        <label for="custom-product-name" class="block text-gray-700 text-sm font-medium mb-2">Nama Produk Kustom (Wajib):</label>
                        <input type="text" id="custom-product-name" placeholder="Nama produk kustom"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200">
                    </div>

                    <div class="mb-4">
                        <label for="custom-price" class="block text-gray-700 text-sm font-medium mb-2">Harga Jual Kustom (Wajib):</label>
                        <input type="number" id="custom-price" placeholder="Masukkan harga jual kustom" value="0" min="0"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200">
                    </div>

                    <div class="mb-6">
                        <label for="custom-quantity" class="block text-gray-700 text-sm font-medium mb-2">Jumlah (Wajib):</label>
                        <input type="number" id="custom-quantity" value="1" min="1"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200">
                    </div>

                    <button id="add-to-cart-btn-custom" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105 w-full mb-6">
                        Tambahkan ke Keranjang (Kustom)
                    </button>
                </div>
            </section>

            <!-- Keranjang Belanja Section -->
            <section class="lg:w-1/2 bg-gray-50 p-6 rounded-lg shadow-md flex flex-col">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 pb-3 border-b-2 border-gray-200">Keranjang Belanja</h2>
                <div id="cart-items" class="flex-grow overflow-y-auto mb-4" style="max-height: 400px;">
                    <!-- Items will be dynamically added here -->
                    <p id="empty-cart-message" class="text-gray-500 text-center">Keranjang kosong.</p>
                </div>
                <div class="border-t border-gray-200 pt-4 mt-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-700 font-medium">Subtotal:</span>
                        <span id="cart-subtotal" class="font-bold text-lg text-gray-900">Rp 0</span>
                    </div>
                    <button id="process-payment-btn" class="bg-green-600 hover:bg-green-700 text-white px-5 py-3 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105 w-full mt-4">
                        Proses Pembayaran
                    </button>
                    <button id="clear-cart-btn" class="mt-4 bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105 w-full">
                        Bersihkan Keranjang
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div id="payment-summary-content" class="bg-gray-50 p-6 rounded-lg shadow-lg w-full max-w-md mx-auto relative transform transition-all sm:my-8 sm:align-middle sm:max-w-lg">
            <button id="close-payment-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Ringkasan Pembayaran</h3>

            <div class="mb-4">
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <span class="text-gray-700">Subtotal:</span>
                    <span class="font-bold text-lg text-gray-900" id="subtotal">Rp 0</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <span class="text-gray-700">Diskon:</span>
                    <input type="number" id="discount-input" value="0" min="0" class="w-24 px-2 py-1 border border-gray-300 rounded-md text-sm text-right focus:outline-none focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="flex justify-between items-center py-2 mt-2">
                    <span class="text-gray-800 text-xl font-semibold">Total:</span>
                    <span class="font-bold text-green-700 text-3xl" id="grand-total">Rp 0</span>
                </div>
            </div>

            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <label for="payment-method-select" class="block text-sm font-medium text-gray-700 mb-1">Metode Pembayaran:</label>
                <select id="payment-method-select" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                    <option value="Tunai">Tunai</option>
                    <option value="Kartu Debit">Kartu Debit</option>
                    <option value="Transfer Bank">Transfer Bank</option>
                    <option value="QRIS">QRIS</option>
                </select>
            </div>

            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <label for="amount-received" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Diterima (Rp):</label>
                <input type="number" id="amount-received" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Masukkan jumlah uang">
                <div class="flex justify-between items-center py-2 mt-4">
                    <span class="text-gray-700">Kembalian:</span>
                    <span class="font-bold text-lg text-blue-600" id="change">Rp 0</span>
                </div>
            </div>

            <button id="process-transaction-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-3 rounded-lg font-semibold text-lg transition duration-200 shadow-md hover:scale-105 w-full">
                Proses Transaksi
            </button>
            <div id="message-box" class="mt-4 p-3 bg-yellow-100 border border-yellow-200 text-yellow-800 rounded-md hidden"></div>
        </div>
    </div>

    <!-- Transaction History Modal -->
    <div id="transaction-history-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-50 p-6 rounded-lg shadow-lg w-full max-w-2xl mx-auto relative transform transition-all sm:my-8 sm:align-middle">
            <button id="close-transaction-history-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Riwayat Transaksi</h3>

            <div class="mb-4 p-4 border border-gray-200 rounded-lg bg-white shadow-sm flex flex-col sm:flex-row items-center gap-4">
                <label for="transaction-date-filter" class="text-gray-700 text-sm font-medium">Filter Tanggal:</label>
                <input type="date" id="transaction-date-filter"
                    class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                <button id="apply-transaction-filter-btn"
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105">
                    Cari
                </button>
                <button id="clear-transaction-filter-btn"
                        class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105">
                    Bersihkan Filter
                </button>
            </div>

            <div class="overflow-x-auto mb-4" style="max-height: 400px;">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Transaksi</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metode Pembayaran</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-history-items" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
                <div id="empty-history-message" class="text-center text-gray-500 mt-4 hidden">Tidak ada riwayat transaksi.</div>
            </div>
        </div>
    </div>

    <!-- Transaction Detail Modal (NEW) -->
    <div id="transaction-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-50 p-6 rounded-lg shadow-lg w-full max-w-md mx-auto relative transform transition-all sm:my-8 sm:align-middle">
            <button id="close-transaction-detail-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Detail Transaksi <span id="detail-transaction-id"></span></h3>

            <div class="mb-4">
                <p class="text-gray-700">Tanggal: <span id="detail-transaction-date" class="font-medium"></span></p>
                <p class="text-gray-700">Total: <span id="detail-transaction-total" class="font-bold text-green-700"></span></p>
                <p class="text-gray-700">Metode Pembayaran: <span id="detail-transaction-payment-method" class="font-medium"></span></p>
                <p class="text-gray-700">Kasir: <span id="detail-transaction-cashier" class="font-medium"></span></p>
            </div>

            <h4 class="text-lg font-semibold text-gray-800 mb-3">Produk Terjual:</h4>
            <div class="overflow-x-auto mb-4" style="max-height: 200px;">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Produk</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Harga</th>
                            <th scope="col" class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th>
                            <th scope="col" class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-detail-items" class="bg-white divide-y divide-gray-200">
                        <!-- Items will be dynamically added here -->
                    </tbody>
                </table>
            </div>
            <div id="transaction-detail-message-box" class="mt-4 p-3 bg-yellow-100 border border-yellow-200 text-yellow-800 rounded-md hidden"></div>
        </div>
    </div>

    <!-- User Settings Modal -->
    <div id="user-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-50 p-6 rounded-lg shadow-lg w-full max-w-xl mx-auto relative transform transition-all sm:my-8 sm:align-middle">
            <button id="close-user-settings-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Pengaturan Pengguna</h3>

            <div class="mb-4 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h4 class="text-lg font-semibold text-gray-800 mb-3">Tambah Pengguna Baru</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                    <div>
                        <label for="new-username" class="block text-gray-700 text-sm font-medium mb-1">Nama Pengguna:</label>
                        <input type="text" id="new-username" placeholder="Nama pengguna"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="new-password" class="block text-gray-700 text-sm font-medium mb-1">Kata Sandi:</label>
                        <input type="password" id="new-password" placeholder="Kata sandi (min 3 karakter)"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="new-user-role" class="block text-gray-700 text-sm font-medium mb-1">Hak Akses:</label>
                        <select id="new-user-role" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                            <option value="kasir">Kasir</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>
                <button id="add-user-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105 w-full">
                    Tambah Pengguna
                </button>
                <div id="user-settings-message-box" class="mt-4 p-3 bg-yellow-100 border border-yellow-200 text-yellow-800 rounded-md hidden"></div>
            </div>

            <h4 class="text-lg font-semibold text-gray-800 mb-3 mt-6">Daftar Pengguna</h4>
            <div class="overflow-x-auto" style="max-height: 300px;">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Pengguna</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hak Akses</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="user-list-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="3" class="text-center py-4 text-gray-500">Memuat pengguna...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Price Calculator Modal -->
    <div id="price-calculator-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-50 p-6 rounded-lg shadow-lg w-full max-w-md mx-auto relative transform transition-all sm:my-8 sm:align-middle">
            <button id="close-price-calculator-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Kalkulator Harga Jual</h3>

            <div class="mb-4">
                <label for="product-code-calc" class="block text-gray-700 text-sm font-medium mb-1">Kode Barang:</label>
                <div class="input-with-copy">
                    <input type="text" id="product-code-calc" placeholder="Opsional"
                        class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                    <button id="copy-product-code-calc" class="copy-button" title="Salin Kode Barang"><i class="far fa-copy"></i></button>
                </div>
            </div>
            <div class="mb-4">
                <label for="product-name-calc" class="block text-gray-700 text-sm font-medium mb-1">Nama Barang:</label>
                <input type="text" id="product-name-calc" placeholder="Nama produk"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
            </div>
            <div class="mb-4">
                <label for="modal-price-calc" class="block text-gray-700 text-sm font-medium mb-1">Modal (Rp):</label>
                <input type="number" id="modal-price-calc" placeholder="Harga modal" min="0"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
            </div>
            <div class="mb-6">
                <label for="margin-percent-calc" class="block text-gray-700 text-sm font-medium mb-1">Margin (%):</label>
                <input type="number" id="margin-percent-calc" placeholder="Persentase margin (e.g., 20)" min="0"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
            </div>

            <button id="calculate-sell-price-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105 w-full mb-4">
                Hitung Harga Jual dan Keuntungan
            </button>

            <div class="p-4 border border-gray-200 rounded-lg bg-white shadow-sm text-center mb-4">
                <p class="text-gray-700 text-md mb-2">Harga Jual:</p>
                <div class="input-with-copy justify-center">
                    <p id="calculated-sell-price-display" class="font-bold text-green-700 text-3xl">Rp 0</p>
                    <button id="copy-calculated-sell-price" class="copy-button" title="Salin Harga Jual"><i class="far fa-copy"></i></button>
                </div>
            </div>
            <div class="p-4 border border-gray-200 rounded-lg bg-white shadow-sm text-center">
                <p class="text-gray-700 text-md mb-2">Keuntungan:</p>
                <p id="calculated-profit-display" class="font-bold text-blue-700 text-3xl">Rp 0</p>
            </div>

            <div id="price-calculator-message-box" class="mt-4 p-3 bg-yellow-100 border border-yellow-200 text-yellow-800 rounded-md hidden"></div>
        </div>
    </div>

    <!-- Expenses Modal (NEW) -->
    <div id="expenses-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-50 p-6 rounded-lg shadow-lg w-full max-w-2xl mx-auto relative transform transition-all sm:my-8 sm:align-middle">
            <button id="close-expenses-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Pengeluaran</h3>

            <!-- Input Pengeluaran Baru -->
            <div class="mb-4 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h4 class="text-lg font-semibold text-gray-800 mb-3">Tambah Pengeluaran Baru</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                    <div>
                        <label for="expense-date" class="block text-gray-700 text-sm font-medium mb-1">Tanggal:</label>
                        <input type="date" id="expense-date"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="expense-amount" class="block text-gray-700 text-sm font-medium mb-1">Jumlah (Rp):</label>
                        <input type="number" id="expense-amount" placeholder="Jumlah pengeluaran" min="0"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                    </div>
                </div>
                <div class="mb-3">
                    <label for="expense-description" class="block text-gray-700 text-sm font-medium mb-1">Deskripsi:</label>
                    <input type="text" id="expense-description" placeholder="Deskripsi pengeluaran (mis. Sewa, Gaji)"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                </div>
                <button id="add-expense-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105 w-full">
                    Tambah Pengeluaran
                </button>
                <div id="expenses-message-box" class="mt-4 p-3 bg-yellow-100 border border-yellow-200 text-yellow-800 rounded-md hidden"></div>
            </div>

            <!-- Filter Pengeluaran -->
            <div class="mb-4 p-4 border border-gray-200 rounded-lg bg-white shadow-sm flex flex-col sm:flex-row items-center gap-4">
                <label for="expenses-date-filter" class="text-gray-700 text-sm font-medium">Filter Tanggal:</label>
                <input type="date" id="expenses-date-filter"
                    class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                <label for="expenses-search-input" class="text-gray-700 text-sm font-medium">Cari Deskripsi:</label>
                <input type="text" id="expenses-search-input" placeholder="Cari..."
                    class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                <button id="apply-expenses-filter-btn"
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105">
                    Cari
                </button>
                <button id="clear-expenses-filter-btn"
                        class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105">
                    Bersihkan Filter
                </button>
            </div>

            <!-- Daftar Pengeluaran -->
            <h4 class="text-lg font-semibold text-gray-800 mb-3 mt-6">Daftar Pengeluaran</h4>
            <div class="overflow-x-auto" style="max-height: 300px;">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="expenses-list-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="4" class="text-center py-4 text-gray-500">Memuat pengeluaran...</td></tr>
                    </tbody>
                </table>
                <div id="empty-expenses-message" class="text-center text-gray-500 mt-4 hidden">Tidak ada pengeluaran.</div>
            </div>
        </div>
    </div>

    <!-- Add Product Modal (NEW) -->
    <div id="add-product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-50 p-6 rounded-lg shadow-lg w-full max-w-md mx-auto relative transform transition-all sm:my-8 sm:align-middle">
            <button id="close-add-product-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Tambah Produk Baru</h3>

            <div class="mb-4">
                <label for="new-product-code" class="block text-gray-700 text-sm font-medium mb-1">Kode Produk (Wajib):</label>
                <input type="text" id="new-product-code" placeholder="Kode unik produk" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
            </div>
            <div class="mb-4">
                <label for="new-product-name" class="block text-gray-700 text-sm font-medium mb-1">Nama Produk (Wajib):</label>
                <input type="text" id="new-product-name" placeholder="Nama produk" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
            </div>
            <div class="mb-4">
                <label for="new-product-price" class="block text-gray-700 text-sm font-medium mb-1">Harga Jual (Rp) (Wajib):</label>
                <input type="number" id="new-product-price" placeholder="Harga jual produk" min="0" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
            </div>
            <div class="mb-4">
                <label for="new-product-cost" class="block text-gray-700 text-sm font-medium mb-1">Harga Modal (Rp) (Wajib):</label>
                <input type="number" id="new-product-cost" placeholder="Harga modal produk" min="0" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
            </div>
            <!-- NEW: Kolom Stok -->
            <div class="mb-6">
                <label for="new-product-stock" class="block text-gray-700 text-sm font-medium mb-1">Stok (Wajib):</label>
                <input type="number" id="new-product-stock" placeholder="Jumlah stok produk" min="0" value="0" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
            </div>

            <button id="add-new-product-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105 w-full">
                Tambahkan Produk
            </button>
            <div id="add-product-message-box" class="mt-4 p-3 bg-yellow-100 border border-yellow-200 text-yellow-800 rounded-md hidden"></div>
        </div>
    </div>

    <!-- Store Products Modal (NEW) -->
    <div id="store-products-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-50 p-6 rounded-lg shadow-lg w-full max-w-2xl mx-auto relative transform transition-all sm:my-8 sm:align-middle">
            <button id="close-store-products-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Daftar Produk Toko</h3>

            <!-- Filter Produk (Opsional, bisa ditambahkan nanti jika diperlukan) -->
            <div class="mb-4 p-4 border border-gray-200 rounded-lg bg-white shadow-sm flex flex-col sm:flex-row items-center gap-4">
                <label for="store-products-search-input" class="text-gray-700 text-sm font-medium">Cari Produk:</label>
                <input type="text" id="store-products-search-input" placeholder="Cari berdasarkan kode atau nama..."
                    class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                <button id="apply-store-products-filter-btn"
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105">
                    Cari
                </button>
                <button id="clear-store-products-filter-btn"
                        class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105">
                    Bersihkan Filter
                </button>
            </div>

            <!-- Daftar Produk -->
            <div class="overflow-x-auto" style="max-height: 400px;">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Produk</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Harga Jual</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Harga Modal</th>
                            <!-- NEW: Kolom Stok -->
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Stok</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="store-product-list-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="6" class="text-center py-4 text-gray-500">Memuat produk...</td></tr>
                    </tbody>
                </table>
                <div id="empty-store-product-message" class="text-center text-gray-500 mt-4 hidden">Tidak ada produk yang terdaftar.</div>
            </div>
            <div id="store-products-message-box" class="mt-4 p-3 bg-yellow-100 border border-yellow-200 text-yellow-800 rounded-md hidden"></div>
        </div>
    </div>

    <!-- Edit Product Modal (NEW) -->
    <div id="edit-product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-50 p-6 rounded-lg shadow-lg w-full max-w-md mx-auto relative transform transition-all sm:my-8 sm:align-middle">
            <button id="close-edit-product-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Edit Produk</h3>

            <div class="mb-4">
                <label for="edit-product-code" class="block text-gray-700 text-sm font-medium mb-1">Kode Produk:</label>
                <input type="text" id="edit-product-code" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 cursor-not-allowed" readonly>
            </div>
            <div class="mb-4">
                <label for="edit-product-name" class="block text-gray-700 text-sm font-medium mb-1">Nama Produk:</label>
                <input type="text" id="edit-product-name" placeholder="Nama produk"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
            </div>
            <div class="mb-4">
                <label for="edit-product-price" class="block text-gray-700 text-sm font-medium mb-1">Harga Jual (Rp):</label>
                <input type="number" id="edit-product-price" placeholder="Harga jual produk" min="0"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
            </div>
            <div class="mb-4">
                <label for="edit-product-cost" class="block text-gray-700 text-sm font-medium mb-1">Harga Modal (Rp):</label>
                <input type="number" id="edit-product-cost" placeholder="Harga modal produk" min="0"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
            </div>
            <!-- NEW: Edit Kolom Stok -->
            <div class="mb-6">
                <label for="edit-product-stock" class="block text-gray-700 text-sm font-medium mb-1">Stok:</label>
                <input type="number" id="edit-product-stock" placeholder="Jumlah stok produk" min="0"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
            </div>

            <button id="save-edited-product-btn" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105 w-full">
                Simpan Perubahan
            </button>
            <div id="edit-product-message-box" class="mt-4 p-3 bg-yellow-100 border border-yellow-200 text-yellow-800 rounded-md hidden"></div>
        </div>
    </div>


    <!-- Financial Report Modal -->
    <div id="financial-report-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-50 p-6 rounded-lg shadow-lg w-full max-w-3xl mx-auto relative transform transition-all sm:my-8 sm:align-middle">
            <button id="close-financial-report-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Laporan Keuangan</h3>

            <!-- Filter Tanggal -->
            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm flex flex-col sm:flex-row items-center gap-4">
                <label for="report-start-date" class="text-gray-700 text-sm font-medium">Dari Tanggal:</label>
                <input type="date" id="report-start-date"
                    class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                <label for="report-end-date" class="text-gray-700 text-sm font-medium">Sampai Tanggal:</label>
                <input type="date" id="report-end-date"
                    class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                <button id="apply-financial-filter-btn"
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105">
                    Terapkan Filter
                </button>
                <button id="clear-financial-filter-btn"
                        class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105">
                    Bersihkan Filter
                </button>
            </div>

            <!-- Ringkasan Keuangan -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow-md text-center">
                    <p class="text-sm text-gray-500">Pendapatan</p>
                    <p id="total-revenue-display" class="text-2xl font-bold text-green-600">Rp 0</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md text-center">
                    <p class="text-sm text-gray-500">Pengeluaran</p>
                    <p id="total-expenses-display" class="text-2xl font-bold text-red-600">Rp 0</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md text-center">
                    <p class="text-sm text-gray-500">Laba Kotor</p>
                    <p id="gross-profit-display" class="text-2xl font-bold text-blue-600">Rp 0</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md text-center">
                    <p class="text-sm text-gray-500">Laba Bersih</p>
                    <p id="net-profit-display" class="text-2xl font-bold text-purple-600">Rp 0</p>
                </div>
            </div>

            <!-- Area Grafik -->
            <div class="bg-white p-4 rounded-lg shadow-md">
                <canvas id="financial-chart"></canvas>
            </div>

            <div id="financial-report-message-box" class="mt-4 p-3 bg-yellow-100 border border-yellow-200 text-yellow-800 rounded-md hidden"></div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script type="module">
        // Ensure all DOM elements are loaded before running the script
        document.addEventListener('DOMContentLoaded', async function() {
            // === Firebase Initialization (if applicable, but for this demo, we only use localStorage) ===
            // Ensure global variables __app_id, __firebase_config, and __initial_auth_token are defined if using Firebase
            // const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

            // let app = null;
            // let db = null;
            // let auth = null;
            // let isAuthReady = false; // Authentication ready status

            let userId = null; // Stored locally for consistency
            let loggedInUser = null; // Our user object from localStorage (username, role)

            // === References to main UI elements ===
            const loginScreen = document.getElementById('login-screen');
            const mainAppContainer = document.getElementById('main-app-container');
            const cashierNameSpan = document.getElementById('cashier-name');
            const todaySalesMainScreen = document.getElementById('today-sales-main-screen');
            const adminMenuToggle = document.getElementById('admin-menu-toggle');
            const adminMenuDropdown = document.getElementById('admin-menu-dropdown');
            const adminMenuContainer = document.getElementById('admin-menu-container');
            const logoutBtn = document.getElementById('logout-btn');

            // Login Screen Elements
            const loginUsernameInput = document.getElementById('login-username');
            const loginPasswordInput = document.getElementById('login-password');
            const loginBtn = document.getElementById('login-btn');
            const loginMessage = document.getElementById('login-message');

            // User Settings Modal Elements
            const openUserSettingsModalBtn = document.getElementById('open-user-settings-modal-btn');
            const userSettingsModal = document.getElementById('user-settings-modal');
            const closeUserSettingsModalBtn = document.getElementById('close-user-settings-modal-btn');
            const userListBody = document.getElementById('user-list-body');
            const newUsernameInput = document.getElementById('new-username');
            const newPasswordInput = document.getElementById('new-password');
            const newUserRoleSelect = document.getElementById('new-user-role');
            const addUserBtn = document.getElementById('add-user-btn');
            const userSettingsMessageBox = document.getElementById('user-settings-message-box');

            // Full Application Data Export/Import Elements
            const exportDataBtn = document.getElementById('export-data-btn');
            const importDataBtn = document.getElementById('import-data-btn');
            const importFileInput = document.getElementById('import-file-input');

            // Product Only Export/Import Elements (NEW)
            const exportProductsBtn = document.getElementById('export-products-btn');
            const importProductsBtn = document.getElementById('import-products-btn');
            const importProductsFileInput = document.getElementById('import-products-file-input');


            // Price Calculator Modal Elements
            const openPriceCalculatorBtn = document.getElementById('open-price-calculator-btn');
            const priceCalculatorModal = document.getElementById('price-calculator-modal');
            const closePriceCalculatorModalBtn = document.getElementById('close-price-calculator-modal-btn');
            const productCodeCalcInput = document.getElementById('product-code-calc');
            const productNameCalcInput = document.getElementById('product-name-calc');
            const modalPriceCalcInput = document.getElementById('modal-price-calc');
            const marginPercentCalcInput = document.getElementById('margin-percent-calc');
            const calculateSellPriceBtn = document.getElementById('calculate-sell-price-btn');
            const calculatedSellPriceDisplay = document.getElementById('calculated-sell-price-display');
            const calculatedProfitDisplay = document.getElementById('calculated-profit-display');
            const priceCalculatorMessageBox = document.getElementById('price-calculator-message-box');
            // Copy buttons for Price Calculator
            const copyProductCodeCalcBtn = document.getElementById('copy-product-code-calc');
            const copyCalculatedSellPriceBtn = document.getElementById('copy-calculated-sell-price');


            // Existing application elements
            const currentDateSpan = document.getElementById('current-date');
            const addProductToCartBtn = document.getElementById('add-to-cart-btn-registered'); // Updated for registered products
            const processPaymentBtn = document.getElementById('process-payment-btn');
            const clearCartBtn = document.getElementById('clear-cart-btn');
            const paymentModal = document.getElementById('payment-modal');
            const closePaymentModalBtn = document.getElementById('close-payment-modal-btn');
            const subtotalSpan = document.getElementById('subtotal');
            const discountInput = document.getElementById('discount-input');
            const grandTotalSpan = document.getElementById('grand-total');
            const paymentMethodSelect = document.getElementById('payment-method-select');
            const amountReceivedInput = document.getElementById('amount-received');
            const changeSpan = document.getElementById('change');
            const processTransactionBtn = document.getElementById('process-transaction-btn');
            const messageBox = document.getElementById('message-box');
            const openTransactionHistoryModalBtn = document.getElementById('open-transaction-history-modal-btn');
            const transactionHistoryModal = document.getElementById('transaction-history-modal');
            const closeTransactionHistoryModalBtn = document.getElementById('close-transaction-history-modal-btn');
            const transactionHistoryTableBody = document.getElementById('transaction-history-items');
            const emptyHistoryMessage = document.getElementById('empty-history-message');
            const transactionDateFilterInput = document.getElementById('transaction-date-filter');
            const applyTransactionFilterBtn = document.getElementById('apply-transaction-filter-btn');
            const clearTransactionFilterBtn = document.getElementById('clear-transaction-filter-btn');

            // Transaction Detail Modal Elements
            const transactionDetailModal = document.getElementById('transaction-detail-modal');
            const closeTransactionDetailModalBtn = document.getElementById('close-transaction-detail-modal-btn');
            const detailTransactionId = document.getElementById('detail-transaction-id');
            const detailTransactionDate = document.getElementById('detail-transaction-date');
            const detailTransactionTotal = document.getElementById('detail-transaction-total');
            const detailTransactionPaymentMethod = document.getElementById('detail-transaction-payment-method');
            const detailTransactionCashier = document.getElementById('detail-transaction-cashier');
            const transactionDetailItems = document.getElementById('transaction-detail-items');
            const transactionDetailMessageBox = document.getElementById('transaction-detail-message-box');


            // Cart elements
            const cartItemsContainer = document.getElementById('cart-items');
            const emptyCartMessage = document.getElementById('empty-cart-message');
            const cartSubtotalSpan = document.getElementById('cart-subtotal');

            // === Expenses Modal Elements ===
            const openExpensesModalBtn = document.getElementById('open-expenses-modal-btn');
            const expensesModal = document.getElementById('expenses-modal');
            const closeExpensesModalBtn = document.getElementById('close-expenses-modal-btn');
            const expenseDateInput = document.getElementById('expense-date');
            const expenseAmountInput = document.getElementById('expense-amount');
            const expenseDescriptionInput = document.getElementById('expense-description');
            const addExpenseBtn = document.getElementById('add-expense-btn');
            const expensesListBox = document.getElementById('expenses-list-body');
            const emptyExpensesMessage = document.getElementById('empty-expenses-message');
            const expensesDateFilterInput = document.getElementById('expenses-date-filter');
            const expensesSearchInput = document.getElementById('expenses-search-input');
            const applyExpensesFilterBtn = document.getElementById('apply-expenses-filter-btn');
            const clearExpensesFilterBtn = document.getElementById('clear-expenses-filter-btn');
            const expensesMessageBox = document.getElementById('expenses-message-box');

            // === Add Product Modal Elements ===
            const openAddProductModalBtn = document.getElementById('open-add-product-modal-btn');
            const addProductModal = document.getElementById('add-product-modal');
            const closeAddProductModalBtn = document.getElementById('close-add-product-modal-btn');
            const newProductCodeInput = document.getElementById('new-product-code');
            const newProductNameInput = document.getElementById('new-product-name');
            const newProductPriceInput = document.getElementById('new-product-price');
            const newProductCostInput = document.getElementById('new-product-cost');
            // Input for new product stock
            const newProductStockInput = document.getElementById('new-product-stock');
            const addNewProductBtn = document.getElementById('add-new-product-btn');
            const addProductMessageBox = document.getElementById('add-product-message-box');

            // === Store Products Modal Elements ===
            const openStoreProductsModalBtn = document.getElementById('open-store-products-modal-btn');
            const storeProductsModal = document.getElementById('store-products-modal');
            const closeStoreProductsModalBtn = document.getElementById('close-store-products-modal-btn');
            const storeProductListBody = document.getElementById('store-product-list-body');
            const emptyStoreProductMessage = document.getElementById('empty-store-product-message');
            const storeProductsSearchInput = document.getElementById('store-products-search-input');
            const applyStoreProductsFilterBtn = document.getElementById('apply-store-products-filter-btn');
            const clearStoreProductsFilterBtn = document.getElementById('clear-store-products-filter-btn');
            const storeProductsMessageBox = document.getElementById('store-products-message-box');

            // === Edit Product Modal Elements ===
            const editProductModal = document.getElementById('edit-product-modal');
            const closeEditProductModalBtn = document.getElementById('close-edit-product-modal-btn');
            const editProductCodeInput = document.getElementById('edit-product-code');
            const editProductNameInput = document.getElementById('edit-product-name');
            const editProductPriceInput = document.getElementById('edit-product-price');
            const editProductCostInput = document.getElementById('edit-product-cost');
            // Input for editing product stock
            const editProductStockInput = document.getElementById('edit-product-stock');
            const saveEditedProductBtn = document.getElementById('save-edited-product-btn');
            const editProductMessageBox = document.getElementById('edit-product-message-box');

            // === Financial Report Modal Elements ===
            const openFinancialReportModalBtn = document.getElementById('open-financial-report-modal-btn');
            const financialReportModal = document.getElementById('financial-report-modal');
            const closeFinancialReportModalBtn = document.getElementById('close-financial-report-modal-btn');
            const reportStartDateInput = document.getElementById('report-start-date');
            const reportEndDateInput = document.getElementById('report-end-date');
            const applyFinancialFilterBtn = document.getElementById('apply-financial-filter-btn');
            const clearFinancialFilterBtn = document.getElementById('clear-financial-filter-btn');
            const totalRevenueDisplay = document.getElementById('total-revenue-display');
            const totalExpensesDisplay = document.getElementById('total-expenses-display');
            const grossProfitDisplay = document.getElementById('gross-profit-display');
            const netProfitDisplay = document.getElementById('net-profit-display');
            const financialChartCanvas = document.getElementById('financial-chart');
            const financialReportMessageBox = document.getElementById('financial-report-message-box');

            let financialChartInstance = null; // To store Chart.js instance

            let cart = []; // Array to store products in the current transaction

            // --- Local Storage Data Management ---
            let transactionsHistory = JSON.parse(localStorage.getItem('transactionsHistory')) || [];
            let appUsers = JSON.parse(localStorage.getItem('appUsers')) || [];
            let appExpenses = JSON.parse(localStorage.getItem('appExpenses')) || []; // Expenses data
            // Updated: Product data now includes 'stock' property
            let products = JSON.parse(localStorage.getItem('products')) || {}; // Product data (now starts empty by default)
            let calculatedProductCodes = JSON.parse(localStorage.getItem('calculatedProductCodes')) || []; // Store calculated product codes

            // Initialize default admin/cashier users if none exist
            if (appUsers.length === 0) {
                appUsers = [
                    { id: 'admin1', username: 'admin', password: 'adminpass', role: 'admin' },
                    { id: 'kasir1', username: 'kasir', password: 'kasirpass', role: 'kasir' }
                ];
                localStorage.setItem('appUsers', JSON.stringify(appUsers));
                console.log("Default users initialized:", appUsers);
            } else {
                console.log("Users loaded from localStorage:", appUsers);
            }

            // Save initial products to localStorage if not already present (or if newly initialized empty)
            // This ensures if 'products' is empty in localStorage, it remains empty until products are added.
            if (!localStorage.getItem('products')) {
                localStorage.setItem('products', JSON.stringify(products));
                console.log("Products initialized and saved to localStorage (possibly empty).");
            } else {
                console.log("Products loaded from localStorage:", products);
            }

            // Save initial calculatedProductCodes to localStorage if not already present
            if (!localStorage.getItem('calculatedProductCodes')) {
                localStorage.setItem('calculatedProductCodes', JSON.stringify(calculatedProductCodes));
                console.log("Calculated product codes initialized and saved to localStorage (possibly empty).");
            } else {
                console.log("Calculated product codes loaded from localStorage:", calculatedProductCodes);
            }


            // --- Custom Confirmation Modal Elements ---
            const confirmModal = document.createElement('div');
            confirmModal.id = 'custom-confirm-modal';
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50';
            confirmModal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-sm mx-auto">
                    <p id="confirm-message" class="text-lg text-gray-800 mb-6 text-center"></p>
                    <div class="flex justify-around gap-4">
                        <button id="confirm-yes-btn" class="bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded-lg font-semibold w-full transition duration-200 hover:scale-105">Ya</button>
                        <button id="confirm-no-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-5 py-2 rounded-lg font-semibold w-full transition duration-200 hover:scale-105">Tidak</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);

            const confirmMessage = document.getElementById('confirm-message');
            const confirmYesBtn = document.getElementById('confirm-yes-btn');
            const confirmNoBtn = document.getElementById('confirm-no-btn');
            let confirmCallback = null; // To store the callback function for confirmation

            // === UI Elements for Product Input Tabs ===
            const tabRegisteredProductBtn = document.getElementById('tab-registered-product');
            const tabCustomProductBtn = document.getElementById('tab-custom-product');
            const registeredProductInputArea = document.getElementById('registered-product-input-area');
            const customProductInputArea = document.getElementById('custom-product-input-area');

            // Registered Product Inputs
            const productCodeInput = document.getElementById('product-code');
            const productNameInput = document.getElementById('product-name');
            const priceInput = document.getElementById('price');
            const quantityInput = document.getElementById('quantity');
            const addToCartRegisteredBtn = document.getElementById('add-to-cart-btn-registered');

            // Custom Product Inputs
            const customProductCodeInput = document.getElementById('custom-product-code');
            const customProductNameInput = document.getElementById('custom-product-name');
            const customPriceInput = document.getElementById('custom-price');
            const customQuantityInput = document.getElementById('custom-quantity');
            const addToCartCustomBtn = document.getElementById('add-to-cart-btn-custom');

            // === New UI Elements for Visibility and Dark Mode ===
            const toggleSalesVisibilityBtn = document.getElementById('toggle-sales-visibility');
            const toggleSalesVisibilityIcon = toggleSalesVisibilityBtn.querySelector('i');
            // The dark mode button is now outside the main app container.
            const toggleDarkModeBtn = document.getElementById('toggle-dark-mode');
            const toggleDarkModeIcon = toggleDarkModeBtn.querySelector('i');

            let isSalesVisible = true; // State for sales visibility
            let isDarkMode = localStorage.getItem('darkMode') === 'true'; // State for dark mode, load from local storage

            // Apply dark mode on initial load
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                toggleDarkModeIcon.classList.remove('fa-lightbulb');
                toggleDarkModeIcon.classList.add('fa-sun'); // Change icon to sun in dark mode
            } else {
                toggleDarkModeIcon.classList.remove('fa-sun');
                toggleDarkModeIcon.classList.add('fa-lightbulb'); // Change icon to lightbulb in light mode
            }

            // --- UI Status Management ---
            function showLoginScreen() {
                loginScreen.classList.remove('hidden');
                mainAppContainer.classList.add('hidden');
                userSettingsModal.classList.add('hidden');
                paymentModal.classList.add('hidden');
                transactionHistoryModal.classList.add('hidden');
                transactionDetailModal.classList.add('hidden'); // Hide transaction detail modal
                priceCalculatorModal.classList.add('hidden');
                expensesModal.classList.add('hidden');
                addProductModal.classList.add('hidden'); // Hide add product modal
                storeProductsModal.classList.add('hidden'); // Hide store products modal
                editProductModal.classList.add('hidden'); // Hide edit product modal
                financialReportModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
                loggedInUser = null; // Ensure loggedInUser is null when showing login screen
                loginUsernameInput.value = ''; // Clear username input
                loginPasswordInput.value = ''; // Clear password input
                loginMessage.classList.add('hidden'); // Hide login message
            }

            function showMainApp() {
                loginScreen.classList.add('hidden');
                mainAppContainer.classList.remove('hidden');
                // Hide admin menu if not admin
                if (loggedInUser && loggedInUser.role === 'admin') {
                    adminMenuContainer.classList.remove('hidden');
                    console.log("Admin Menu SHOWN for user:", loggedInUser.username, "Role:", loggedInUser.role);
                } else {
                    adminMenuContainer.classList.add('hidden');
                    console.log("Admin Menu HIDDEN for user:", loggedInUser ? loggedInUser.username : 'No User', "Role:", loggedInUser ? loggedInUser.role : 'N/A');
                }
                updateCurrentDate(); // Call to update date
                updateTodaySalesDisplay(); // Call to update today's sales
                renderCart(); // Render cart when main app is displayed
                showRegisteredProductTab(); // Show registered product tab by default
            }

            // Function to switch between product input tabs
            function switchProductInputTab(tabType) {
                if (tabType === 'registered') {
                    tabRegisteredProductBtn.classList.add('active-cashier');
                    tabRegisteredProductBtn.classList.remove('inactive-cashier');
                    tabCustomProductBtn.classList.add('inactive-custom-cashier');
                    tabCustomProductBtn.classList.remove('active-custom-cashier');
                    registeredProductInputArea.classList.remove('hidden');
                    customProductInputArea.classList.add('hidden');

                    // Clear custom product inputs when switching to registered
                    customProductCodeInput.value = '';
                    customProductNameInput.value = '';
                    customPriceInput.value = '0';
                    customQuantityInput.value = '1';
                } else if (tabType === 'custom') {
                    tabCustomProductBtn.classList.add('active-custom-cashier');
                    tabCustomProductBtn.classList.remove('inactive-custom-cashier');
                    tabRegisteredProductBtn.classList.add('inactive-cashier');
                    tabRegisteredProductBtn.classList.remove('active-cashier');
                    customProductInputArea.classList.remove('hidden');
                    registeredProductInputArea.classList.add('hidden');

                    // Clear registered product inputs when switching to custom
                    productCodeInput.value = '';
                    productNameInput.value = '';
                    priceInput.value = '0';
                    quantityInput.value = '1';
                }
                // Clear the main message box when switching tabs
                messageBox.classList.add('hidden');
            }

            // Initial call to show registered product tab
            function showRegisteredProductTab() {
                switchProductInputTab('registered');
            }

            function showMessage(message, type = 'info') {
                messageBox.textContent = message;
                messageBox.classList.remove('hidden', 'bg-red-100', 'border-red-200', 'text-red-800', 'bg-green-100', 'border-green-200', 'text-green-800', 'bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                if (type === 'error') {
                    messageBox.classList.add('bg-red-100', 'border-red-200', 'text-red-800');
                } else if (type === 'success') {
                    messageBox.classList.add('bg-green-100', 'border-green-200', 'text-green-800');
                } else {
                    messageBox.classList.add('bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                }
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 3000); // Hide after 3 seconds
            }

            function showUserSettingsMessage(message, type = 'info') {
                userSettingsMessageBox.textContent = message;
                userSettingsMessageBox.classList.remove('hidden', 'bg-red-100', 'border-red-200', 'text-red-800', 'bg-green-100', 'border-green-200', 'text-green-800', 'bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                if (type === 'error') {
                    userSettingsMessageBox.classList.add('bg-red-100', 'border-red-200', 'text-red-800');
                } else if (type === 'success') {
                    userSettingsMessageBox.classList.add('bg-green-100', 'border-green-200', 'text-green-800');
                } else {
                    userSettingsMessageBox.classList.add('bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                }
                setTimeout(() => {
                    userSettingsMessageBox.classList.add('hidden');
                }, 3000);
            }

            function showPriceCalculatorMessage(message, type = 'info') {
                priceCalculatorMessageBox.textContent = message;
                priceCalculatorMessageBox.classList.remove('hidden', 'bg-red-100', 'border-red-200', 'text-red-800', 'bg-green-100', 'border-green-200', 'text-green-800', 'bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                if (type === 'error') {
                    priceCalculatorMessageBox.classList.add('bg-red-100', 'border-red-200', 'text-red-800');
                } else if (type === 'success') {
                    priceCalculatorMessageBox.classList.add('bg-green-100', 'border-green-200', 'text-green-800');
                } else {
                    priceCalculatorMessageBox.classList.add('bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                }
                setTimeout(() => {
                    priceCalculatorMessageBox.classList.add('hidden');
                }, 3000);
            }

            function showExpensesMessage(message, type = 'info') {
                expensesMessageBox.textContent = message;
                expensesMessageBox.classList.remove('hidden', 'bg-red-100', 'border-red-200', 'text-red-800', 'bg-green-100', 'border-green-200', 'text-green-800', 'bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                if (type === 'error') {
                    expensesMessageBox.classList.add('bg-red-100', 'border-red-200', 'text-red-800');
                } else if (type === 'success') {
                    expensesMessageBox.classList.add('bg-green-100', 'border-green-200', 'text-green-800');
                } else {
                    expensesMessageBox.classList.add('bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                }
                setTimeout(() => {
                    expensesMessageBox.classList.add('hidden');
                }, 3000);
            }

            function showAddProductMessage(message, type = 'info') {
                addProductMessageBox.textContent = message;
                addProductMessageBox.classList.remove('hidden', 'bg-red-100', 'border-red-200', 'text-red-800', 'bg-green-100', 'border-green-200', 'text-green-800', 'bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                if (type === 'error') {
                    addProductMessageBox.classList.add('bg-red-100', 'border-red-200', 'text-red-800');
                } else if (type === 'success') {
                    addProductMessageBox.classList.add('bg-green-100', 'border-green-200', 'text-green-800');
                } else {
                    addProductMessageBox.classList.add('bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                }
                setTimeout(() => {
                    addProductMessageBox.classList.add('hidden');
                }, 3000);
            }

            function showStoreProductsMessage(message, type = 'info') {
                storeProductsMessageBox.textContent = message;
                storeProductsMessageBox.classList.remove('hidden', 'bg-red-100', 'border-red-200', 'text-red-800', 'bg-green-100', 'border-green-200', 'text-green-800', 'bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                if (type === 'error') {
                    storeProductsMessageBox.classList.add('bg-red-100', 'border-red-200', 'text-red-800');
                } else if (type === 'success') {
                    storeProductsMessageBox.classList.add('bg-green-100', 'border-green-200', 'text-green-800');
                } else {
                    storeProductsMessageBox.classList.add('bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                }
                setTimeout(() => {
                    storeProductsMessageBox.classList.add('hidden');
                }, 3000);
            }

            // === Functions for Financial Report Modal ===
            function showFinancialReportMessage(message, type = 'info') {
                financialReportMessageBox.textContent = message;
                financialReportMessageBox.classList.remove('hidden', 'bg-red-100', 'border-red-200', 'text-red-800', 'bg-green-100', 'border-green-200', 'text-green-800', 'bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                if (type === 'error') {
                    financialReportMessageBox.classList.add('bg-red-100', 'border-red-200', 'text-red-800');
                } else if (type === 'success') {
                    financialReportMessageBox.classList.add('bg-green-100', 'border-green-200', 'text-green-800');
                } else {
                    financialReportMessageBox.classList.add('bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                }
                setTimeout(() => {
                    financialReportMessageBox.classList.add('hidden');
                }, 3000);
            }

            // === Functions for Edit Product Modal ===
            function showEditProductMessage(message, type = 'info') {
                editProductMessageBox.textContent = message;
                editProductMessageBox.classList.remove('hidden', 'bg-red-100', 'border-red-200', 'text-red-800', 'bg-green-100', 'border-green-200', 'text-green-800', 'bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                if (type === 'error') {
                    editProductMessageBox.classList.add('bg-red-100', 'border-red-200', 'text-red-800');
                } else if (type === 'success') {
                    editProductMessageBox.classList.add('bg-green-100', 'border-green-200', 'text-green-800');
                } else {
                    editProductMessageBox.classList.add('bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                }
                setTimeout(() => {
                    editProductMessageBox.classList.add('hidden');
                }, 3000);
            }

            // === Functions for Transaction Detail Modal ===
            function showTransactionDetailMessage(message, type = 'info') {
                transactionDetailMessageBox.textContent = message;
                transactionDetailMessageBox.classList.remove('hidden', 'bg-red-100', 'border-red-200', 'text-red-800', 'bg-green-100', 'border-green-200', 'text-green-800', 'bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                if (type === 'error') {
                    transactionDetailMessageBox.classList.add('bg-red-100', 'border-red-200', 'text-red-800');
                } else if (type === 'success') {
                    transactionDetailMessageBox.classList.add('bg-green-100', 'border-green-200', 'text-green-800');
                } else {
                    transactionDetailMessageBox.classList.add('bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                }
                setTimeout(() => {
                    transactionDetailMessageBox.classList.add('hidden');
                }, 3000);
            }


            function formatCurrency(amount) {
                return new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    minimumFractionDigits: 0
                }).format(amount);
            }

            // Function to update the current date display
            function updateCurrentDate() {
                const now = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                currentDateSpan.textContent = `Tanggal: ${now.toLocaleDateString('id-ID', options)}`;
            }

            function showConfirmModal(message, onConfirm) {
                confirmMessage.textContent = message;
                confirmCallback = onConfirm;
                confirmModal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            }

            function hideConfirmModal() {
                confirmModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
                confirmCallback = null;
            }

            confirmYesBtn.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                hideConfirmModal();
            });

            confirmNoBtn.addEventListener('click', () => {
                hideConfirmModal();
            });

            // --- Login Logic (using localStorage) ---
            loginBtn.addEventListener('click', async () => {
                const username = loginUsernameInput.value.trim();
                const password = loginPasswordInput.value.trim();

                if (!username || !password) {
                    loginMessage.textContent = 'Nama pengguna dan Kata Sandi tidak boleh kosong.';
                    loginMessage.classList.remove('hidden');
                    return;
                }
                loginMessage.classList.add('hidden');

                const foundUser = appUsers.find(user => user.username === username && user.password === password);

                if (foundUser) {
                    loggedInUser = { ...foundUser }; // Copy user data
                    userId = foundUser.id; // Set local userId
                    console.log("Login successful. Logged-in user:", loggedInUser);
                    cashierNameSpan.textContent = `Kasir: ${loggedInUser.username} (${loggedInUser.role})`;
                    showMainApp();
                } else {
                    loginMessage.textContent = 'Nama pengguna atau kata sandi salah.';
                    loginMessage.classList.remove('hidden');
                }
            });

            // --- Logout Logic (using localStorage) ---
            logoutBtn.addEventListener('click', async () => {
                showConfirmModal('Apakah Anda yakin ingin logout?', async () => {
                    loggedInUser = null; // Clear internal user status
                    cart = []; // Clear cart on logout
                    console.log("User logged out.");
                    showLoginScreen(); // Show login screen
                });
            });

            // --- User Settings Modal Logic (using localStorage) ---
            openUserSettingsModalBtn.addEventListener('click', () => {
                if (!loggedInUser || loggedInUser.role !== 'admin') {
                    showMessage('Anda tidak memiliki hak akses untuk fitur ini.', 'error');
                    return;
                }
                userSettingsModal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
                renderUserList();
            });

            closeUserSettingsModalBtn.addEventListener('click', () => {
                userSettingsModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            });

            function renderUserList() {
                userListBody.innerHTML = '';
                if (appUsers.length === 0) {
                    userListBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-500">Tidak ada pengguna.</td></tr>`;
                    return;
                }

                appUsers.forEach(user => {
                    const row = userListBody.insertRow();
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.username}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.role}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            ${(loggedInUser && user.id !== loggedInUser.id) ? `<button data-id="${user.id}" class="text-red-600 hover:text-red-900 ml-4 delete-user-btn">Hapus</button>` : `<span class="text-gray-400">Anda</span>`}
                        </td>
                    `;
                });

                document.querySelectorAll('.delete-user-btn').forEach(button => {
                    button.addEventListener('click', deleteUser);
                });
            }

            addUserBtn.addEventListener('click', async () => {
                const username = newUsernameInput.value.trim();
                const password = newPasswordInput.value.trim();
                const role = newUserRoleSelect.value;

                if (!username || !password) {
                    showUserSettingsMessage('Nama pengguna dan Kata Sandi tidak boleh kosong.', 'error');
                    return;
                }
                if (password.length < 3) { // Minimum password length for demo
                    showUserSettingsMessage('Kata sandi harus minimal 3 karakter.', 'error');
                    return;
                }

                // Check if username already exists
                const existingUser = appUsers.find(user => user.username === username);
                if (existingUser) {
                    showUserSettingsMessage('Nama pengguna sudah ada. Pilih nama lain.', 'error');
                    return;
                }

                const newUserId = 'user_' + Date.now(); // Simple unique ID
                appUsers.push({ id: newUserId, username: username, password: password, role: role });
                localStorage.setItem('appUsers', JSON.stringify(appUsers));
                console.log("User added. Current appUsers:", appUsers);

                showUserSettingsMessage('Pengguna berhasil ditambahkan!', 'success');
                newUsernameInput.value = ''; // Clear input
                newPasswordInput.value = ''; // Clear password input
                newUserRoleSelect.value = 'kasir'; // Reset dropdown
                renderUserList(); // Re-render list
            });

            async function deleteUser(event) {
                const userIdToDelete = event.target.dataset.id;
                showConfirmModal(`Apakah Anda yakin ingin menghapus pengguna ini?`, async () => {
                    // Prevent deleting the currently logged-in user
                    if (loggedInUser && loggedInUser.id === userIdToDelete) {
                        showUserSettingsMessage('Tidak dapat menghapus pengguna yang sedang login.', 'error');
                        return;
                    }

                    appUsers = appUsers.filter(user => user.id !== userIdToDelete);
                    localStorage.setItem('appUsers', JSON.stringify(appUsers));
                    console.log("User deleted. Current appUsers:", appUsers);
                    showUserSettingsMessage('Pengguna berhasil dihapus!', 'success');
                    renderUserList(); // Re-render list
                });
            }

            // --- Full Application Data Export/Import Functions ---
            function exportData() {
                if (!loggedInUser || loggedInUser.role !== 'admin') {
                    showMessage('Anda tidak memiliki hak akses untuk mengekspor data.', 'error');
                    return;
                }

                showConfirmModal('Apakah Anda yakin ingin mengekspor semua data aplikasi (pengguna, riwayat transaksi, pengeluaran, dan produk toko)?', () => {
                    const dataToExport = {
                        appUsers: appUsers,
                        transactionsHistory: transactionsHistory,
                        appExpenses: appExpenses, // Include expenses data
                        products: products, // Include products data
                        calculatedProductCodes: calculatedProductCodes // Include calculated product codes
                    };
                    const dataStr = JSON.stringify(dataToExport, null, 2); // Pretty print JSON

                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `unix_app_data_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showMessage('Data berhasil diekspor!', 'success');
                });
            }

            function importData() {
                if (!loggedInUser || loggedInUser.role !== 'admin') {
                    showMessage('Anda tidak memiliki hak akses untuk mengimpor data.', 'error');
                    return;
                }
                // Trigger click on hidden file input
                importFileInput.click();
            }

            importFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) {
                    showMessage('Tidak ada file yang dipilih.', 'info');
                    return;
                }

                if (file.type !== 'application/json') {
                    showMessage('Hanya file JSON (.json) yang diizinkan untuk diimpor.', 'error');
                    return;
                }

                showConfirmModal('Apakah Anda yakin ingin mengimpor data? Ini akan MENIMPA data yang ada saat ini.', () => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importedData = JSON.parse(e.target.result);

                            if (importedData.appUsers && Array.isArray(importedData.appUsers)) {
                                appUsers = importedData.appUsers;
                                localStorage.setItem('appUsers', JSON.stringify(appUsers));
                                console.log('Users imported successfully.');
                            } else {
                                console.warn('No valid appUsers found in imported file, skipping user import.');
                            }

                            if (importedData.transactionsHistory && Array.isArray(importedData.transactionsHistory)) {
                                transactionsHistory = importedData.transactionsHistory;
                                localStorage.setItem('transactionsHistory', JSON.stringify(transactionsHistory));
                                console.log('Transactions imported successfully.');
                            } else {
                                console.warn('No valid transactionsHistory found in imported file, skipping transaction import.');
                            }

                            if (importedData.appExpenses && Array.isArray(importedData.appExpenses)) {
                                appExpenses = importedData.appExpenses;
                                localStorage.setItem('appExpenses', JSON.stringify(appExpenses));
                                console.log('Expenses imported successfully.');
                            } else {
                                console.warn('No valid appExpenses found in imported file, skipping expenses import.');
                            }

                            if (importedData.products && typeof importedData.products === 'object' && !Array.isArray(importedData.products)) {
                                products = importedData.products;
                                // Ensure all imported products have a 'stock' property, default to 0 if missing
                                for (const code in products) {
                                    if (products.hasOwnProperty(code) && typeof products[code].stock === 'undefined') {
                                        products[code].stock = 0;
                                    }
                                }
                                localStorage.setItem('products', JSON.stringify(products));
                                console.log('Products imported successfully.');
                            } else {
                                console.warn('No valid products found in imported file, skipping product import.');
                            }

                            // Import calculatedProductCodes
                            if (importedData.calculatedProductCodes && Array.isArray(importedData.calculatedProductCodes)) {
                                calculatedProductCodes = importedData.calculatedProductCodes;
                                localStorage.setItem('calculatedProductCodes', JSON.stringify(calculatedProductCodes));
                                console.log('Calculated product codes imported successfully.');
                            } else {
                                console.warn('No valid calculatedProductCodes found in imported file, skipping calculated product codes import.');
                            }


                            showMessage('Data berhasil diimpor dan diperbarui! Harap segarkan halaman untuk melihat perubahan.', 'success');
                            renderUserList(); // Re-render user list
                            renderTransactionHistory(); // Re-render transaction history
                            renderStoreProductsList(); // Update store products list
                            updateTodaySalesDisplay(); // Update today sales
                            // No need to call calculateFinancialSummaryAndRenderChart() here, it will be called when modal is opened
                        } catch (error) {
                            showMessage('Gagal mengurai file JSON. Pastikan format file benar.', 'error');
                            console.error('Error importing data:', error);
                        }
                    };
                    reader.readAsText(file);
                });
            });


            // --- Product Only Export/Import Functions (NEW) ---
            function exportProducts() {
                if (!loggedInUser || loggedInUser.role !== 'admin') {
                    showMessage('Anda tidak memiliki hak akses untuk mengekspor produk.', 'error');
                    return;
                }

                showConfirmModal('Apakah Anda yakin ingin mengekspor hanya data produk toko?', () => {
                    const productsToExport = products;
                    const dataStr = JSON.stringify(productsToExport, null, 2);

                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `unix_products_data_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showMessage('Data produk berhasil diekspor!', 'success');
                });
            }

            function importProducts() {
                if (!loggedInUser || loggedInUser.role !== 'admin') {
                    showMessage('Anda tidak memiliki hak akses untuk mengimpor produk.', 'error');
                    return;
                }
                importProductsFileInput.click();
            }

            importProductsFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) {
                    showMessage('Tidak ada file yang dipilih.', 'info');
                    return;
                }

                if (file.type !== 'application/json') {
                    showMessage('Hanya file JSON (.json) yang diizinkan untuk diimpor.', 'error');
                    return;
                }

                showConfirmModal('Apakah Anda yakin ingin mengimpor data produk? Produk dengan kode yang sama akan DITIMPA, dan produk baru akan DITAMBAHKAN.', () => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importedProductsData = JSON.parse(e.target.result);

                            if (typeof importedProductsData !== 'object' || Array.isArray(importedProductsData)) {
                                showMessage('Format file produk tidak valid. Harap impor objek JSON produk.', 'error');
                                return;
                            }

                            let productsAdded = 0;
                            let productsUpdated = 0;

                            for (const code in importedProductsData) {
                                if (importedProductsData.hasOwnProperty(code)) {
                                    const importedProduct = importedProductsData[code];
                                    // Ensure imported product has necessary properties
                                    if (importedProduct.name && typeof importedProduct.price === 'number' && typeof importedProduct.cost === 'number') {
                                        if (products[code]) {
                                            // Update existing product
                                            products[code] = {
                                                name: importedProduct.name,
                                                price: importedProduct.price,
                                                cost: importedProduct.cost,
                                                // Ensure stock exists, if not, default to existing value or 0
                                                stock: typeof importedProduct.stock === 'number' ? importedProduct.stock : products[code].stock || 0
                                            };
                                            productsUpdated++;
                                        } else {
                                            // Add new product
                                            products[code] = {
                                                name: importedProduct.name,
                                                price: importedProduct.price,
                                                cost: importedProduct.cost,
                                                stock: typeof importedProduct.stock === 'number' ? importedProduct.stock : 0
                                            };
                                            productsAdded++;
                                        }
                                    } else {
                                        console.warn(`Skipping product with code ${code} due to incomplete or invalid data.`, importedProduct);
                                    }
                                }
                            }

                            localStorage.setItem('products', JSON.stringify(products));
                            console.log('Products after import:', products);
                            showStoreProductsMessage(`Product import complete. Added: ${productsAdded}, Updated: ${productsUpdated}.`, 'success');
                            renderStoreProductsList(); // Update product list display
                        } catch (error) {
                            showStoreProductsMessage('Gagal mengurai file JSON produk. Pastikan format file benar.', 'error');
                            console.error('Error importing products:', error);
                        }
                    };
                    reader.readAsText(file);
                });
            });


            // --- Price Calculator Functions ---
            function openPriceCalculatorModal() {
                if (!loggedInUser || loggedInUser.role !== 'admin') {
                    showMessage('Anda tidak memiliki hak akses untuk fitur ini.', 'error');
                    return;
                }
                priceCalculatorModal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
                // Clear previous values
                productCodeCalcInput.value = '';
                productNameCalcInput.value = '';
                modalPriceCalcInput.value = '';
                marginPercentCalcInput.value = '';
                calculatedSellPriceDisplay.textContent = formatCurrency(0);
                calculatedProfitDisplay.textContent = formatCurrency(0);
                priceCalculatorMessageBox.classList.add('hidden');
            }

            function hidePriceCalculatorModal() {
                priceCalculatorModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }

            function calculateSellPrice() {
                const code = productCodeCalcInput.value.trim().toUpperCase();
                const modalPrice = parseFloat(modalPriceCalcInput.value);
                const marginPercent = parseFloat(marginPercentCalcInput.value);

                if (!code) {
                    showPriceCalculatorMessage('Kode Barang tidak boleh kosong.', 'error');
                    return;
                }

                // Check if product code has been calculated before and not deleted from store products
                // Only warn if code is not in `products` object (meaning it's not a stored product being re-calculated)
                if (calculatedProductCodes.includes(code) && !products[code]) {
                    showPriceCalculatorMessage('Kode Barang ini sudah pernah dihitung sebelumnya dan belum dihapus dari daftar produk toko. Harap gunakan kode lain atau hapus produk ini dari daftar produk toko jika ingin menghitung ulang.', 'error');
                    calculatedSellPriceDisplay.textContent = formatCurrency(0);
                    calculatedProfitDisplay.textContent = formatCurrency(0);
                    return;
                }


                if (isNaN(modalPrice) || modalPrice < 0) {
                    showPriceCalculatorMessage('Modal harus angka positif.', 'error');
                    calculatedSellPriceDisplay.textContent = formatCurrency(0);
                    calculatedProfitDisplay.textContent = formatCurrency(0);
                    return;
                }
                if (isNaN(marginPercent) || marginPercent < 0) {
                    showPriceCalculatorMessage('Margin harus angka positif.', 'error');
                    calculatedSellPriceDisplay.textContent = formatCurrency(0);
                    calculatedProfitDisplay.textContent = formatCurrency(0);
                    return;
                }

                const sellingPrice = modalPrice + (modalPrice * (marginPercent / 100));
                const profit = sellingPrice - modalPrice; // Calculate profit

                calculatedSellPriceDisplay.textContent = formatCurrency(sellingPrice);
                calculatedProfitDisplay.textContent = formatCurrency(profit);
                showPriceCalculatorMessage('Harga jual dan keuntungan berhasil dihitung!', 'success');

                // Add calculated product code to the list
                if (!calculatedProductCodes.includes(code)) {
                    calculatedProductCodes.push(code);
                    localStorage.setItem('calculatedProductCodes', JSON.stringify(calculatedProductCodes));
                }
            }

            // --- Copy Functions ---
            function copyToClipboard(text, messageElement) {
                // Use a temporary input element to copy text
                const tempInput = document.createElement('input');
                tempInput.value = text;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    document.execCommand('copy');
                    messageElement.textContent = 'Disalin!';
                    messageElement.classList.remove('hidden', 'bg-red-100', 'border-red-200', 'text-red-800', 'bg-yellow-100');
                    messageElement.classList.add('bg-green-100', 'border-green-200', 'text-green-800');
                } catch (err) {
                    messageElement.textContent = 'Gagal menyalin.';
                    messageElement.classList.remove('hidden', 'bg-green-100', 'border-green-200', 'text-green-800', 'bg-yellow-100');
                    messageElement.classList.add('bg-red-100', 'border-red-200', 'text-red-800');
                    console.error('Failed to copy: ', err);
                }
                document.body.removeChild(tempInput);
                setTimeout(() => {
                    messageElement.classList.add('hidden');
                }, 1500); // Hide "Copied!" message after 1.5 seconds
            }

            // === Expenses Modal Functions ===
            function showExpensesModal() {
                if (!loggedInUser || loggedInUser.role !== 'admin') {
                    showMessage('Anda tidak memiliki hak akses untuk fitur ini.', 'error');
                    return;
                }
                expensesModal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
                // Set date input to current date by default
                expenseDateInput.valueAsDate = new Date();
                expenseAmountInput.value = '';
                expenseDescriptionInput.value = '';
                expensesDateFilterInput.value = ''; // Clear filter on open
                expensesSearchInput.value = ''; // Clear filter on open
                renderExpensesList(); // Display latest expenses list
            }

            function hideExpensesModal() {
                expensesModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }

            function addExpense() {
                const date = expenseDateInput.value;
                const amount = parseFloat(expenseAmountInput.value);
                const description = expenseDescriptionInput.value.trim();

                if (!date || isNaN(amount) || amount <= 0 || !description) {
                    showExpensesMessage('Harap lengkapi semua bidang: Tanggal, Jumlah, dan Deskripsi pengeluaran yang valid.', 'error');
                    return;
                }

                const newExpense = {
                    id: 'EXP-' + Date.now(),
                    date: date, // Format YYYY-MM-DD
                    amount: amount,
                    description: description
                };

                appExpenses.push(newExpense);
                localStorage.setItem('appExpenses', JSON.stringify(appExpenses));
                showExpensesMessage('Pengeluaran berhasil ditambahkan!', 'success');
                console.log('Expense added:', newExpense);

                // Clear inputs
                expenseAmountInput.value = '';
                expenseDescriptionInput.value = '';
                expenseDateInput.valueAsDate = new Date(); // Reset date to today

                renderExpensesList(); // Update expenses list
            }

            function renderExpensesList(filterDate = null, searchTerm = '') {
                expensesListBox.innerHTML = '';
                let filteredExpenses = appExpenses;

                // Filter by date
                if (filterDate) {
                    filteredExpenses = filteredExpenses.filter(exp => exp.date === filterDate);
                }

                // Filter by description (case-insensitive)
                if (searchTerm) {
                    const lowerCaseSearchTerm = searchTerm.toLowerCase();
                    filteredExpenses = filteredExpenses.filter(exp =>
                        exp.description.toLowerCase().includes(lowerCaseSearchTerm)
                    );
                }

                if (filteredExpenses.length === 0) {
                    emptyExpensesMessage.classList.remove('hidden');
                } else {
                    emptyExpensesMessage.classList.add('hidden');
                    // Sort expenses by date, newest first
                    const sortedExpenses = [...filteredExpenses].sort((a, b) => new Date(b.date) - new Date(a.date));

                    sortedExpenses.forEach(expense => {
                        const row = expensesListBox.insertRow();
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${expense.date}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${expense.description}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">${formatCurrency(expense.amount)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button data-id="${expense.id}" class="text-red-600 hover:text-red-900 delete-expense-btn">Hapus</button>
                            </td>
                        `;
                    });

                    document.querySelectorAll('.delete-expense-btn').forEach(button => {
                        button.addEventListener('click', deleteExpense);
                    });
                }
            }

            async function deleteExpense(event) {
                const expenseIdToDelete = event.target.dataset.id;
                showConfirmModal(`Apakah Anda yakin ingin menghapus pengeluaran ini?`, async () => {
                    appExpenses = appExpenses.filter(exp => exp.id !== expenseIdToDelete);
                    localStorage.setItem('appExpenses', JSON.stringify(appExpenses));
                    showExpensesMessage('Pengeluaran berhasil dihapus!', 'info');
                    renderExpensesList(expensesDateFilterInput.value, expensesSearchInput.value); // Re-render with current filters
                    // After deleting an expense, update financial report too
                    calculateFinancialSummaryAndRenderChart();
                });
            }

            // === Add New Product Modal Functions ===
            function showAddProductModal() {
                if (!loggedInUser || loggedInUser.role !== 'admin') {
                    showMessage('Anda tidak memiliki hak akses untuk fitur ini.', 'error');
                    return;
                }
                addProductModal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
                // Clear inputs when opening modal
                newProductCodeInput.value = '';
                newProductNameInput.value = '';
                newProductPriceInput.value = '';
                newProductCostInput.value = '';
                newProductStockInput.value = '0'; // Set default stock to 0
                addProductMessageBox.classList.add('hidden');
            }

            function hideAddProductModal() {
                addProductModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }

            function addNewProduct() {
                const code = newProductCodeInput.value.trim().toUpperCase();
                const name = newProductNameInput.value.trim();
                const price = parseFloat(newProductPriceInput.value);
                const cost = parseFloat(newProductCostInput.value);
                const stock = parseInt(newProductStockInput.value); // Get stock value

                // --- REQUIRED FIELD VALIDATION ---
                if (!code) {
                    showAddProductMessage('Kode Produk wajib diisi.', 'error');
                    return;
                }
                if (!name) {
                    showAddProductMessage('Nama Produk wajib diisi.', 'error');
                    return;
                }
                if (isNaN(price) || price < 0) {
                    showAddProductMessage('Harga Jual wajib diisi dan harus angka positif.', 'error');
                    return;
                }
                if (isNaN(cost) || cost < 0) {
                    showAddProductMessage('Harga Modal wajib diisi dan harus angka positif.', 'error');
                    return;
                }
                // Stock validation is required
                if (newProductStockInput.value.trim() === '' || isNaN(stock) || stock < 0) {
                    showAddProductMessage('Stok wajib diisi dan harus angka positif.', 'error');
                    return;
                }
                // --- END REQUIRED FIELD VALIDATION ---

                if (products[code]) {
                    showAddProductMessage('Kode produk sudah ada. Harap gunakan kode lain.', 'error');
                    return;
                }

                products[code] = { name: name, price: price, cost: cost, stock: stock }; // Include stock
                localStorage.setItem('products', JSON.stringify(products));
                showAddProductMessage(`Produk "${name}" with code ${code} berhasil ditambahkan!`, 'success');
                console.log('New product added:', products[code]);

                // Clear inputs
                newProductCodeInput.value = '';
                newProductNameInput.value = '';
                newProductPriceInput.value = '';
                newProductCostInput.value = '';
                newProductStockInput.value = '0'; // Reset stock input

                renderStoreProductsList(); // Update store products list after adding new product
            }

            // === Store Products Modal Functions ===
            function showStoreProductsModal() {
                if (!loggedInUser || loggedInUser.role !== 'admin') {
                    showMessage('Anda tidak memiliki hak akses untuk fitur ini.', 'error');
                    return;
                }
                storeProductsModal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
                storeProductsSearchInput.value = ''; // Clear filter on open
                renderStoreProductsList(); // Display product list
            }

            function hideStoreProductsModal() {
                storeProductsModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }

            function renderStoreProductsList(searchTerm = '') {
                storeProductListBody.innerHTML = '';
                const productEntries = Object.entries(products); // Get [key, value] array from products object
                let filteredProducts = productEntries;

                // Filter by search term (code or name)
                if (searchTerm) {
                    const lowerCaseSearchTerm = searchTerm.toLowerCase();
                    filteredProducts = filteredProducts.filter(([code, product]) =>
                        code.toLowerCase().includes(lowerCaseSearchTerm) ||
                        product.name.toLowerCase().includes(lowerCaseSearchTerm)
                    );
                }

                if (filteredProducts.length === 0) {
                    emptyStoreProductMessage.classList.remove('hidden');
                } else {
                    emptyStoreProductMessage.classList.add('hidden');
                    // Sort products by code
                    const sortedProducts = [...filteredProducts].sort(([codeA], [codeB]) => codeA.localeCompare(codeB));

                    sortedProducts.forEach(([code, product]) => {
                        const row = storeProductListBody.insertRow();
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${code}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">${formatCurrency(product.price)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">${formatCurrency(product.cost)}</td>
                            <!-- Display Stock -->
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900 ${product.stock === 0 ? 'text-red-500 font-bold' : ''}">${product.stock}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button data-code="${code}" class="text-blue-600 hover:text-blue-900 edit-store-product-btn">Edit</button>
                                <button data-code="${code}" class="text-red-600 hover:text-red-900 ml-4 delete-store-product-btn">Hapus</button>
                            </td>
                        `;
                    });

                    document.querySelectorAll('.edit-store-product-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const productCode = e.target.dataset.code;
                            const productToEdit = products[productCode];
                            if (productToEdit) {
                                // Pass stock value to edit modal
                                showEditProductModal(productCode, productToEdit.name, productToEdit.price, productToEdit.cost, productToEdit.stock);
                            } else {
                                showStoreProductsMessage('Product not found for editing.', 'error');
                            }
                        });
                    });
                    document.querySelectorAll('.delete-store-product-btn').forEach(button => {
                        button.addEventListener('click', deleteStoreProduct);
                    });
                }
            }

            async function deleteStoreProduct(event) {
                const productCodeToDelete = event.target.dataset.code;
                showConfirmModal(`Apakah Anda yakin ingin menghapus produk "${products[productCodeToDelete].name}" with code ${productCodeToDelete}?`, async () => {
                    delete products[productCodeToDelete];
                    localStorage.setItem('products', JSON.stringify(products));
                    showStoreProductsMessage('Produk berhasil dihapus!', 'info');
                    renderStoreProductsList(storeProductsSearchInput.value); // Re-render with current filters

                    // Remove code from calculatedProductCodes if it exists
                    const indexInCalculated = calculatedProductCodes.indexOf(productCodeToDelete);
                    if (indexInCalculated > -1) {
                        calculatedProductCodes.splice(indexInCalculated, 1);
                        localStorage.setItem('calculatedProductCodes', JSON.stringify(calculatedProductCodes));
                        console.log(`Removed ${productCodeToDelete} from calculatedProductCodes.`);
                    }
                });
            }

            // === Edit Product Modal Functions ===
            // Updated: Added 'stock' parameter
            function showEditProductModal(code, name, price, cost, stock) {
                editProductModal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
                editProductCodeInput.value = code;
                editProductNameInput.value = name;
                editProductPriceInput.value = price;
                editProductCostInput.value = cost;
                editProductStockInput.value = stock; // Set stock value
                editProductMessageBox.classList.add('hidden');
            }

            function hideEditProductModal() {
                editProductModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }

            function saveEditedProduct() {
                const code = editProductCodeInput.value.trim().toUpperCase();
                const name = editProductNameInput.value.trim();
                const price = parseFloat(editProductPriceInput.value);
                const cost = parseFloat(editProductCostInput.value);
                const stock = parseInt(editProductStockInput.value); // Get edited stock

                if (!code || !name || isNaN(price) || price < 0 || isNaN(cost) || cost < 0 || isNaN(stock) || stock < 0) {
                    showEditProductMessage('Harap lengkapi semua bidang dengan nilai yang valid: Kode, Nama, Harga Jual, Harga Modal, dan Stok.', 'error');
                    return;
                }

                products[code] = { name: name, price: price, cost: cost, stock: stock }; // Update stock
                localStorage.setItem('products', JSON.stringify(products));
                showEditProductMessage(`Produk "${name}" with code ${code} berhasil diperbarui!`, 'success');
                console.log('Product updated:', products[code]);

                renderStoreProductsList(); // Update store products list
                hideEditProductModal();
            }


            // === Financial Report Modal Functions ===
            function showFinancialReportModal() {
                if (!loggedInUser || loggedInUser.role !== 'admin') {
                    showMessage('Anda tidak memiliki hak akses untuk fitur ini.', 'error');
                    return;
                }
                financialReportModal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');

                // Set default start and end dates to this month
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                reportStartDateInput.value = firstDayOfMonth.toISOString().slice(0, 10);
                reportEndDateInput.value = today.toISOString().slice(0, 10);

                // Calculate and render financial report when modal opens
                calculateFinancialSummaryAndRenderChart();
            }

            function hideFinancialReportModal() {
                financialReportModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
                if (financialChartInstance) {
                    financialChartInstance.destroy(); // Destroy existing instance before creating a new one
                    financialChartInstance = null;
                }
            }

            function calculateFinancialSummaryAndRenderChart() {
                const startDate = reportStartDateInput.value ? new Date(reportStartDateInput.value) : null;
                const endDate = reportEndDateInput.value ? new Date(reportEndDateInput.value) : null;

                if (startDate && endDate && startDate > endDate) {
                    showFinancialReportMessage('Tanggal mulai tidak boleh lebih lambat dari tanggal akhir.', 'error');
                    totalRevenueDisplay.textContent = formatCurrency(0);
                    totalExpensesDisplay.textContent = formatCurrency(0);
                    grossProfitDisplay.textContent = formatCurrency(0);
                    netProfitDisplay.textContent = formatCurrency(0);
                    renderFinancialChart([], []); // Render empty chart
                    return;
                }

                let totalRevenue = 0;
                let totalCostOfGoodsSold = 0; // Add variable for total COGS
                let totalExpenses = 0;

                // Calculate revenue and COGS from transactions
                const filteredTransactions = transactionsHistory.filter(trans => {
                    const transDate = new Date(trans.dateForComparison || (new Date(trans.dateDisplay).toISOString().slice(0, 10)));
                    if (startDate && transDate < startDate) return false;
                    // Add 1 day to endDate for inclusive comparison
                    const inclusiveEndDate = endDate ? new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate() + 1) : null;
                    if (inclusiveEndDate && transDate >= inclusiveEndDate) return false;
                    return true;
                });

                filteredTransactions.forEach(trans => {
                    totalRevenue += trans.total;
                    // Calculate COGS for each item in the transaction
                    trans.items.forEach(item => {
                        // Ensure item has costPrice. For custom products, costPrice is already calculated when added to cart.
                        // For registered products, costPrice is fetched from `products` or 0 if not found.
                        // Here, we assume item.costPrice is already correct.
                        totalCostOfGoodsSold += (item.costPrice || 0) * item.quantity;
                    });
                });

                // Calculate expenses
                const filteredExpenses = appExpenses.filter(exp => {
                    const expDate = new Date(exp.date);
                    if (startDate && expDate < startDate) return false;
                    // Add 1 day to endDate for inclusive comparison
                    const inclusiveEndDate = endDate ? new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate() + 1) : null;
                    if (inclusiveEndDate && expDate >= inclusiveEndDate) return false;
                    return true;
                });

                filteredExpenses.forEach(exp => {
                    totalExpenses += exp.amount;
                });

                const grossProfit = totalRevenue - totalCostOfGoodsSold; // Gross Profit = Revenue - COGS
                const netProfit = grossProfit - totalExpenses; // Net Profit = Gross Profit - Expenses

                totalRevenueDisplay.textContent = formatCurrency(totalRevenue);
                totalExpensesDisplay.textContent = formatCurrency(totalExpenses);
                grossProfitDisplay.textContent = formatCurrency(grossProfit);
                netProfitDisplay.textContent = formatCurrency(netProfit);

                renderFinancialChart(filteredTransactions, filteredExpenses);
                showFinancialReportMessage('Laporan keuangan diperbarui.', 'success');
            }

            function renderFinancialChart(transactions, expenses) {
                if (financialChartInstance) {
                    financialChartInstance.destroy(); // Destroy existing instance before creating a new one
                }

                const dates = new Set();
                transactions.forEach(t => dates.add(t.dateForComparison));
                expenses.forEach(e => dates.add(e.date));

                const sortedDates = Array.from(dates).sort();

                const revenueData = sortedDates.map(date => {
                    return transactions
                        .filter(t => t.dateForComparison === date)
                        .reduce((sum, t) => sum + t.total, 0);
                });

                const expensesData = sortedDates.map(date => {
                    return expenses
                        .filter(e => e.date === date)
                        .reduce((sum, e) => sum + e.amount, 0);
                });

                financialChartInstance = new Chart(financialChartCanvas, {
                    type: 'bar',
                    data: {
                        labels: sortedDates,
                        datasets: [
                            {
                                label: 'Pendapatan (Rp)',
                                data: revenueData,
                                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Pengeluaran (Rp)',
                                data: expensesData,
                                backgroundColor: 'rgba(255, 99, 132, 0.6)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // Important for responsiveness within a div
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Tanggal'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Jumlah (Rp)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += formatCurrency(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        }
                    }
                });
            }

            // --- Existing Application Functions (adapted for localStorage) ---
            function showPaymentModal() {
                paymentModal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden'); // Prevent background scrolling
            }

            function hidePaymentModal() {
                paymentModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden'); // Re-enable background scrolling
            }

            function showTransactionHistoryModal() {
                // When opening history modal, display all transactions by default
                renderTransactionHistory();
                transactionHistoryModal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            }

            function hideTransactionHistoryModal() {
                transactionHistoryModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }

            // Function to show transaction detail modal
            function showTransactionDetailModal(transaction) {
                if (!transaction) {
                    showTransactionDetailMessage('Transaction details not found.', 'error');
                    return;
                }

                detailTransactionId.textContent = transaction.id;
                detailTransactionDate.textContent = transaction.dateDisplay;
                detailTransactionTotal.textContent = formatCurrency(transaction.total);
                detailTransactionPaymentMethod.textContent = transaction.paymentMethod;
                detailTransactionCashier.textContent = transaction.cashierUsername;

                transactionDetailItems.innerHTML = ''; // Clear previous items
                if (transaction.items && transaction.items.length > 0) {
                    transaction.items.forEach(item => {
                        const row = transactionDetailItems.insertRow();
                        row.innerHTML = `
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${item.name}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${formatCurrency(item.price)}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-right text-sm text-gray-900">${item.quantity}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-right text-sm text-gray-900">${formatCurrency(item.price * item.quantity)}</td>
                        `;
                    });
                } else {
                    const row = transactionDetailItems.insertRow();
                    row.innerHTML = `<td colspan="4" class="text-center py-4 text-gray-500">Tidak ada produk dalam transaksi ini.</td>`;
                }

                transactionDetailModal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            }

            // Function to hide transaction detail modal
            function hideTransactionDetailModal() {
                transactionDetailModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }


            function updateSummary() {
                let currentSubtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                let discount = parseFloat(discountInput.value) || 0; // Get discount value

                // Ensure discount doesn't make total negative
                if (discount > currentSubtotal) {
                    discount = currentSubtotal; // Discount cannot exceed subtotal
                    discountInput.value = discount; // Update input field
                }

                let currentGrandTotal = currentSubtotal - discount; // Deduct discount

                subtotalSpan.textContent = formatCurrency(currentSubtotal); // Subtotal before discount
                grandTotalSpan.textContent = formatCurrency(currentGrandTotal); // Final total after discount

                // Update change calculation
                calculateChange();

                // Update subtotal in cart
                cartSubtotalSpan.textContent = formatCurrency(currentSubtotal);
            }

            function calculateChange() {
                const grandTotalStr = grandTotalSpan.textContent.replace('Rp', '').replace(/\./g, '').trim();
                const grandTotal = parseFloat(grandTotalStr) || 0;
                const amountReceived = parseFloat(amountReceivedInput.value) || 0;
                const change = amountReceived - grandTotal;
                changeSpan.textContent = formatCurrency(change);
                changeSpan.classList.toggle('text-red-600', change < 0);
                changeSpan.classList.toggle('text-blue-600', change >= 0);
            }

            // Function to render cart items
            function renderCart() {
                cartItemsContainer.innerHTML = '';
                if (cart.length === 0) {
                    emptyCartMessage.classList.remove('hidden');
                } else {
                    emptyCartMessage.classList.add('hidden');
                    cart.forEach((item, index) => {
                        const itemElement = document.createElement('div');
                        itemElement.className = 'flex justify-between items-center bg-white p-3 rounded-md shadow-sm mb-2';
                        itemElement.innerHTML = `
                            <div>
                                <p class="font-semibold text-gray-800">${item.name}</p>
                                <p class="text-sm text-gray-600">${formatCurrency(item.price)} x ${item.quantity}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button data-index="${index}" class="update-quantity-btn bg-gray-200 hover:bg-gray-300 text-gray-700 w-8 h-8 rounded-full flex items-center justify-center text-lg font-bold" data-change="-1">-</button>
                                <span class="text-gray-900 font-bold">${formatCurrency(item.price * item.quantity)}</span>
                                <button data-index="${index}" class="update-quantity-btn bg-gray-200 hover:bg-gray-300 text-gray-700 w-8 h-8 rounded-full flex items-center justify-center text-lg font-bold" data-change="1">+</button>
                                <button data-index="${index}" class="remove-from-cart-btn bg-red-500 hover:bg-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-lg font-bold ml-2">x</button>
                            </div>
                        `;
                        cartItemsContainer.appendChild(itemElement);
                    });
                    // Add event listeners for new buttons
                    document.querySelectorAll('.update-quantity-btn').forEach(button => {
                        button.addEventListener('click', updateCartItemQuantity);
                    });
                    document.querySelectorAll('.remove-from-cart-btn').forEach(button => {
                        button.addEventListener('click', removeCartItem);
                    });
                }
                updateSummary(); // Always update summary after rendering cart
            }

            // Update cart item quantity
            function updateCartItemQuantity(event) {
                const index = parseInt(event.target.dataset.index);
                const change = parseInt(event.target.dataset.change);

                if (cart[index]) {
                    // Check if it's a registered product to enforce stock limits
                    const isRegisteredProduct = !cart[index].id.startsWith('CUSTOM_');
                    const currentProductInStore = isRegisteredProduct ? products[cart[index].id] : null;

                    if (isRegisteredProduct && currentProductInStore) {
                        // Prevent adding more than available stock for registered products
                        if ((cart[index].quantity + change) > currentProductInStore.stock) {
                            showMessage(`Stok ${currentProductInStore.name} hanya ${currentProductInStore.stock}.`, 'error');
                            return;
                        }
                    }

                    // Prevent quantity from going below one (if decrementing, remove if becomes 0)
                    if (cart[index].quantity + change < 1 && change === -1) {
                         cart.splice(index, 1); // If trying to reduce to 0 or less, just remove it
                    } else {
                        cart[index].quantity += change;
                    }

                    // If quantity becomes 0 or less, remove item from cart
                    if (cart[index] && cart[index].quantity <= 0) {
                        cart.splice(index, 1);
                    }
                    renderCart();
                }
            }

            // Remove item from cart
            function removeCartItem(event) {
                const index = parseInt(event.target.dataset.index);
                if (cart[index]) {
                    cart.splice(index, 1);
                    renderCart();
                }
            }

            // Logic to add product to cart (from product input fields)
            function addProductToCart(productCode, productName, price, quantity, isCustom = false) {
                console.log("addProductToCart called with:", productCode, productName, price, quantity, "Custom:", isCustom);

                if (!productName || isNaN(price) || price < 0 || isNaN(quantity) || quantity <= 0) {
                    showMessage('Harap masukkan Nama Produk, Harga, dan Kuantitas yang valid.', 'error');
                    return;
                }

                let productData = {
                    id: productCode || (isCustom ? 'CUSTOM_' + Date.now() : 'UNKNOWN_' + Date.now()), // Ensure unique ID for custom products
                    name: productName,
                    price: price,
                    quantity: quantity
                };

                // Determine costPrice based on product type
                if (isCustom) {
                    // For custom products, cost is 80% of selling price (20% margin)
                    productData.costPrice = price * 0.8;
                    productData.type = 'custom';
                } else {
                    // For registered products, fetch cost from `products` object
                    const registeredProduct = products[productCode];
                    if (registeredProduct) {
                        productData.costPrice = registeredProduct.cost;
                        productData.type = 'registered';

                        // Check stock for registered product before adding to cart
                        if (registeredProduct.stock <= 0) {
                            showMessage('Stok Habis!', 'error');
                            // Clear inputs when out of stock
                            productCodeInput.value = '';
                            productNameInput.value = '';
                            priceInput.value = '0';
                            quantityInput.value = '1';
                            return; // Don't add to cart
                        }
                        if (registeredProduct.stock < quantity) {
                            showMessage(`Stok ${productName} hanya ${registeredProduct.stock}.`, 'error');
                            return; // Don't add to cart if quantity exceeds initial stock
                        }
                    } else {
                        // This should not happen if logic for registered product is correct, but as a fallback
                        productData.costPrice = price; // Assume no profit if cost not found
                        productData.type = 'registered_fallback'; // Mark as fallback type
                    }
                }

                const existingItemIndex = cart.findIndex(item => item.id === productData.id);

                if (existingItemIndex > -1) {
                    const newQuantity = cart[existingItemIndex].quantity + quantity;
                    // Re-check stock for registered products if updating quantity
                    if (!isCustom && products[productData.id] && newQuantity > products[productData.id].stock) {
                         showMessage(`Penambahan akan melebihi stok. Stok tersedia: ${products[productData.id].stock}. Sudah ada di keranjang: ${cart[existingItemIndex].quantity}.`, 'error');
                         return;
                    }
                    cart[existingItemIndex].quantity = newQuantity;
                } else {
                    cart.push(productData);
                }

                // Clear inputs based on active tab
                if (isCustom) {
                    customProductCodeInput.value = '';
                    customProductNameInput.value = '';
                    customPriceInput.value = '0';
                    customQuantityInput.value = '1';
                } else {
                    productCodeInput.value = '';
                    productNameInput.value = '';
                    priceInput.value = '0';
                    quantityInput.value = '1';
                }


                showMessage(`Produk "${productName}" ditambahkan ke keranjang.`, 'success');
                renderCart(); // Re-render cart
            }

            // Auto-fill Input Handling (Debounced) for Registered Products
            let productCodeInputTimeout = null;
            productCodeInput.addEventListener('input', function() {
                clearTimeout(productCodeInputTimeout); // Clear previous timeout

                const code = productCodeInput.value.trim().toUpperCase();
                const product = products[code];

                // If product code is not empty and product is found, auto-fill other fields
                if (code && product) {
                    productNameInput.value = product.name;
                    priceInput.value = product.price;
                    quantityInput.value = '1'; // Reset quantity to 1

                    // Check stock for auto-add
                    if (product.stock <= 0) {
                        showMessage('Stok Habis!', 'error');
                        productCodeInput.value = ''; // Clear input if out of stock
                        productNameInput.value = '';
                        priceInput.value = '0';
                        quantityInput.value = '1';
                        return; // Stop auto-add process
                    }
                    // If stock is available, set timeout for auto-add
                    productCodeInputTimeout = setTimeout(() => {
                        console.log("Debounced: Attempting to auto-add registered product:", code);
                        // Ensure stock is still sufficient at time of auto-add
                        if (product.stock > 0) { // Double check here
                            addProductToCart(code, product.name, product.price, parseInt(quantityInput.value) || 1, false);
                        } else {
                            showMessage('Stok Habis!', 'error');
                            productCodeInput.value = '';
                            productNameInput.value = '';
                            priceInput.value = '0';
                            quantityInput.value = '1';
                        }
                    }, 300); // Wait 300ms after input stops

                } else {
                    // If product code does not match, clear name and price fields
                    // But don't clear if user is typing a custom product without a code
                    productNameInput.value = '';
                    priceInput.value = '0';
                }
            });

            // Add event listener for "Tambahkan ke Keranjang" (Registered Product)
            addToCartRegisteredBtn.addEventListener('click', () => {
                const productCode = productCodeInput.value.trim().toUpperCase();
                const productName = productNameInput.value.trim();
                const price = parseFloat(priceInput.value);
                const quantity = parseInt(quantityInput.value) || 1; // Default to 1 if not set or invalid

                // Validate inputs for registered product
                if (!productCode || !products[productCode]) {
                    showMessage('Pilih produk terdaftar yang valid menggunakan kode produk.', 'error');
                    return;
                }
                const productData = products[productCode];
                if (productData.stock <= 0) {
                    showMessage('Stok Habis!', 'error');
                    return;
                }
                if (productData.stock < quantity) {
                    showMessage(`Stok ${productName} hanya ${productData.stock}.`, 'error');
                    return;
                }

                addProductToCart(productCode, productData.name, productData.price, quantity, false);
            });

            // Add event listener for "Tambahkan ke Keranjang" (Custom Product)
            addToCartCustomBtn.addEventListener('click', () => {
                const customCode = customProductCodeInput.value.trim().toUpperCase();
                const customName = customProductNameInput.value.trim();
                const customPrice = parseFloat(customPriceInput.value);
                const customQuantity = parseInt(customQuantityInput.value) || 1;

                // Validate inputs for custom product
                if (!customName) {
                    showMessage('Nama Produk Kustom wajib diisi.', 'error');
                    return;
                }
                if (isNaN(customPrice) || customPrice <= 0) {
                    showMessage('Harga Jual Kustom wajib diisi dan harus angka positif.', 'error');
                    return;
                }
                if (isNaN(customQuantity) || customQuantity <= 0) {
                    showMessage('Jumlah wajib diisi dan harus angka positif.', 'error');
                    return;
                }

                // Check if custom product code clashes with any registered product code
                if (customCode && products[customCode]) {
                    showMessage('Kode Produk Kustom tidak boleh sama dengan produk terdaftar!', 'error');
                    return;
                }

                addProductToCart(customCode || 'CUSTOM_' + Date.now(), customName, customPrice, customQuantity, true);
            });


            // Add event listener for Enter on quantity input to add to cart
            quantityInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); // Prevent default form submission
                    addToCartRegisteredBtn.click(); // Call registered product button click function
                }
            });
            customQuantityInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); // Prevent default form submission
                    addToCartCustomBtn.click(); // Call custom product button click function
                }
            });


            function clearCart() {
                if (cart.length > 0) {
                    cart = [];
                    renderCart(); // Render empty cart
                    showMessage('Keranjang belanja dikosongkan.', 'info');
                    amountReceivedInput.value = ''; // Clear amount received
                    discountInput.value = '0'; // Reset discount
                }
            }

            async function processTransaction() {
                if (cart.length === 0) {
                    showMessage('Keranjang kosong. Tidak ada transaksi untuk diproses.', 'error');
                    return;
                }

                const grandTotal = parseFloat(grandTotalSpan.textContent.replace('Rp', '').replace(/\./g, '').trim()) || 0;
                const amountReceived = parseFloat(amountReceivedInput.value) || 0;
                const selectedPaymentMethod = paymentMethodSelect.value;

                if (amountReceived < grandTotal) {
                    showMessage('Jumlah uang diterima tidak mencukupi.', 'error');
                    return;
                }

                // Decrease stock for each item in the cart if it's a registered product
                const itemsToProcess = [];
                for (const item of cart) {
                    let costPrice = item.costPrice; // Use the costPrice already determined when adding to cart

                    // For registered products, update stock
                    if (!item.id.startsWith('CUSTOM_')) { // Only deduct stock for registered products
                        if (products[item.id]) {
                            if (products[item.id].stock < item.quantity) {
                                // This check should ideally happen BEFORE entering the payment modal
                                // but as a safeguard, it's here too.
                                showMessage(`Stok tidak cukup untuk produk "${item.name}". Stok tersedia: ${products[item.id].stock}`, 'error');
                                return; // Stop transaction if stock is insufficient
                            }
                            products[item.id].stock -= item.quantity;
                        }
                    }
                    itemsToProcess.push({ ...item, costPrice: costPrice });
                }

                // Save updated product stock to localStorage
                localStorage.setItem('products', JSON.stringify(products));

                const transaction = {
                    id: 'TRX-' + Date.now(), // Generate local ID for offline
                    dateDisplay: new Date().toLocaleString('id-ID', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }),
                    dateForComparison: new Date().toISOString().slice(0, 10), // Format YYYY-MM-DD for easy comparison
                    total: grandTotal,
                    subtotal: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                    discount: parseFloat(discountInput.value) || 0,
                    paymentMethod: selectedPaymentMethod,
                    amountReceived: amountReceived,
                    change: amountReceived - grandTotal,
                    items: JSON.parse(JSON.stringify(itemsToProcess)), // Use items with calculated costPrice
                    cashierId: loggedInUser ? loggedInUser.id : 'anonymous',
                    cashierUsername: loggedInUser ? loggedInUser.username : 'Anonim'
                };

                transactionsHistory.push(transaction);
                localStorage.setItem('transactionsHistory', JSON.stringify(transactionsHistory)); // Save to localStorage

                showMessage('Transaksi berhasil diproses!', 'success');
                console.log('Transaction processed:', transaction);
                clearCart();
                amountReceivedInput.value = '';
                changeSpan.textContent = formatCurrency(0);
                updateTodaySalesDisplay(); // Update sales on main screen
                hidePaymentModal(); // Close payment modal after successful transaction
            }

            function renderTransactionHistory(filterDate = null) {
                transactionHistoryTableBody.innerHTML = '';
                let filteredHistory = transactionsHistory;
                if (filterDate) {
                    filteredHistory = transactionsHistory.filter(trans => {
                        const transDate = trans.dateForComparison || (new Date(trans.dateDisplay).toISOString().slice(0, 10));
                        return transDate === filterDate;
                    });
                }

                if (filteredHistory.length === 0) {
                    emptyHistoryMessage.classList.remove('hidden');
                } else {
                    emptyHistoryMessage.classList.add('hidden');
                    const sortedHistory = [...filteredHistory].sort((a, b) => new Date(b.dateDisplay) - new Date(a.dateDisplay));
                    sortedHistory.forEach(transaction => {
                        const row = transactionHistoryTableBody.insertRow();
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${transaction.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${transaction.dateDisplay}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(transaction.total)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${transaction.paymentMethod}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium flex gap-2">
                                <button data-id="${transaction.id}" class="text-blue-600 hover:text-blue-900 detail-transaction-btn">Detail</button>
                                <button data-id="${transaction.id}" class="text-red-600 hover:text-red-900 delete-transaction-btn">Hapus</button>
                            </td>
                        `;
                    });
                    document.querySelectorAll('.delete-transaction-btn').forEach(button => {
                        button.addEventListener('click', deleteTransaction);
                    });
                    document.querySelectorAll('.detail-transaction-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const transactionId = event.target.dataset.id;
                            const transaction = transactionsHistory.find(t => t.id === transactionId);
                            showTransactionDetailModal(transaction);
                        });
                    });
                }
            }

            async function deleteTransaction(event) {
                const transactionIdToDelete = String(event.target.dataset.id);
                showConfirmModal(`Apakah Anda yakin ingin menghapus transaksi dengan ID ${transactionIdToDelete}?`, async () => {
                    const transactionToDelete = transactionsHistory.find(trans => trans.id === transactionIdToDelete);

                    if (transactionToDelete) {
                        // Return stock for registered products
                        transactionToDelete.items.forEach(item => {
                            // Only return stock if it's a registered product (not custom)
                            if (products[item.id] && !item.id.startsWith('CUSTOM_')) {
                                products[item.id].stock += item.quantity;
                                console.log(`Stock for product "${item.name}" (code: ${item.id}) returned by ${item.quantity}. New stock: ${products[item.id].stock}`);
                            }
                        });
                        // Save updated products back to localStorage
                        localStorage.setItem('products', JSON.stringify(products));
                    }

                    transactionsHistory = transactionsHistory.filter(trans => trans.id !== transactionIdToDelete);
                    localStorage.setItem('transactionsHistory', JSON.stringify(transactionsHistory)); // Save to localStorage
                    showMessage(`Transaksi ${transactionIdToDelete} telah dihapus. Stok produk yang relevan telah dikembalikan.`, 'info');
                    renderTransactionHistory(transactionDateFilterInput.value || null); // Re-render history
                    updateTodaySalesDisplay(); // Update sales
                    renderStoreProductsList(); // Update store products list display to show updated stock
                });
            }

            // Function to update today's sales display
            function updateTodaySalesDisplay() {
                const todayFormatted = new Date().toISOString().slice(0, 10);
                let totalSalesToday = 0;
                transactionsHistory.forEach(transaction => {
                    let transactionDateForComparison = transaction.dateForComparison;
                    // Ensure transaction has dateForComparison, if not try to get from dateDisplay
                    if (!transactionDateForComparison && transaction.dateDisplay) {
                        const parsedDate = new Date(transaction.dateDisplay);
                        // Check if parsedDate is a valid date
                        if (!isNaN(parsedDate.getTime())) {
                            transactionDateForComparison = parsedDate.toISOString().slice(0, 10);
                        } else {
                            console.warn('Invalid dateDisplay encountered, skipping transaction for sales calculation:', transaction.dateDisplay);
                            return; // Skip this transaction if dateDisplay is invalid
                        }
                    }

                    // Only add sales if transaction date matches today's date
                    if (transactionDateForComparison === todayFormatted) {
                        totalSalesToday += transaction.total;
                    }
                });
                todaySalesMainScreen.textContent = formatCurrency(totalSalesToday);
            }

            // Function to check and reset daily sales if date changes
            function checkAndResetDailySales() {
                const today = new Date().toISOString().slice(0, 10); // Format YYYY-MM-DD
                const lastAccessDate = localStorage.getItem('lastAccessDate'); // Last date app was opened

                if (lastAccessDate !== today) {
                    console.log(`Date changed from ${lastAccessDate} to ${today}. Resetting daily revenue.`);
                    // Optional: You can add logic to archive 'previous day's revenue' if needed
                    // For example, save totalSalesToday from previous date to a separate daily revenue history.

                    // Update total sales for the new date (will be re-calculated)
                    updateTodaySalesDisplay();
                } else {
                    console.log(`Still on the same date (${today}). Daily revenue maintained.`);
                }
                // Always update last access date
                localStorage.setItem('lastAccessDate', today);
            }

            // --- Event Listeners ---
            processPaymentBtn.addEventListener('click', showPaymentModal);

            clearCartBtn.addEventListener('click', clearCart);

            paymentModal.addEventListener('click', function(event) {
                if (event.target === paymentModal) { hidePaymentModal(); }
            });
            closePaymentModalBtn.addEventListener('click', hidePaymentModal);
            discountInput.addEventListener('input', updateSummary);
            amountReceivedInput.addEventListener('input', calculateChange);
            amountReceivedInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter' && !paymentModal.classList.contains('hidden')) { event.preventDefault(); processTransaction(); }
            });
            processTransactionBtn.addEventListener('click', processTransaction);

            openTransactionHistoryModalBtn.addEventListener('click', showTransactionHistoryModal);
            closeTransactionHistoryModalBtn.addEventListener('click', hideTransactionHistoryModal);
            transactionHistoryModal.addEventListener('click', function(event) {
                if (event.target === transactionHistoryModal) { hideTransactionHistoryModal(); }
            });

            // Transaction Detail Modal Event Listener
            closeTransactionDetailModalBtn.addEventListener('click', hideTransactionDetailModal);
            transactionDetailModal.addEventListener('click', function(event) {
                if (event.target === transactionDetailModal) { hideTransactionDetailModal(); }
            });

            applyTransactionFilterBtn.addEventListener('click', function() {
                const filterDate = transactionDateFilterInput.value;
                renderTransactionHistory(filterDate);
            });
            clearTransactionFilterBtn.addEventListener('click', function() {
                transactionDateFilterInput.value = '';
                renderTransactionHistory();
            });

            // === Event Listeners for Financial Report ===
            openFinancialReportModalBtn.addEventListener('click', showFinancialReportModal);
            closeFinancialReportModalBtn.addEventListener('click', hideFinancialReportModal);
            financialReportModal.addEventListener('click', function(event) {
                if (event.target === financialReportModal) { hideFinancialReportModal(); }
            });
            applyFinancialFilterBtn.addEventListener('click', calculateFinancialSummaryAndRenderChart);
            clearFinancialFilterBtn.addEventListener('click', function() {
                reportStartDateInput.value = '';
                reportEndDateInput.value = '';
                calculateFinancialSummaryAndRenderChart(); // Recalculate without filters
            });

            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    if (!paymentModal.classList.contains('hidden')) { hidePaymentModal(); }
                    if (!transactionHistoryModal.classList.contains('hidden')) { hideTransactionHistoryModal(); }
                    if (!transactionDetailModal.classList.contains('hidden')) { hideTransactionDetailModal(); } // Close detail modal
                    if (!userSettingsModal.classList.contains('hidden')) { userSettingsModal.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); }
                    if (!priceCalculatorModal.classList.contains('hidden')) { hidePriceCalculatorModal(); }
                    if (!expensesModal.classList.contains('hidden')) { hideExpensesModal(); }
                    if (!addProductModal.classList.contains('hidden')) { hideAddProductModal(); }
                    if (!storeProductsModal.classList.contains('hidden')) { hideStoreProductsModal(); }
                    if (!editProductModal.classList.contains('hidden')) { hideEditProductModal(); } // Close edit product modal
                    if (!financialReportModal.classList.contains('hidden')) { hideFinancialReportModal(); }
                    if (!confirmModal.classList.contains('hidden')) { hideConfirmModal(); }
                }
            });

            // Toggle Admin Menu Dropdown
            adminMenuToggle.addEventListener('click', function() {
                adminMenuDropdown.classList.toggle('hidden');
            });

            // Close dropdown if user clicks outside dropdown area
            window.addEventListener('click', function(event) {
                if (!adminMenuContainer.contains(event.target)) {
                    adminMenuDropdown.classList.add('hidden');
                }
            });

            // Admin Menu Button Listeners
            openPriceCalculatorBtn.addEventListener('click', openPriceCalculatorModal);
            openExpensesModalBtn.addEventListener('click', showExpensesModal);
            openAddProductModalBtn.addEventListener('click', showAddProductModal);
            openStoreProductsModalBtn.addEventListener('click', showStoreProductsModal);

            // Event Listeners for FULL DATA Export/Import
            exportDataBtn.addEventListener('click', exportData);
            importDataBtn.addEventListener('click', importData);

            // Event Listeners for PRODUCT ONLY Export/Import (NEW)
            exportProductsBtn.addEventListener('click', exportProducts);
            importProductsBtn.addEventListener('click', importProducts);


            // Event Listeners for Price Calculator Modal
            closePriceCalculatorModalBtn.addEventListener('click', hidePriceCalculatorModal);
            priceCalculatorModal.addEventListener('click', function(event) {
                if (event.target === priceCalculatorModal) { hidePriceCalculatorModal(); }
            });
            calculateSellPriceBtn.addEventListener('click', calculateSellPrice);
            modalPriceCalcInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') { event.preventDefault(); calculateSellPrice(); }
            });
            marginPercentCalcInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') { event.preventDefault(); calculateSellPrice(); }
            });

            // Copy button event listeners for Price Calculator
            copyProductCodeCalcBtn.addEventListener('click', () => {
                copyToClipboard(productCodeCalcInput.value, priceCalculatorMessageBox);
            });

            copyCalculatedSellPriceBtn.addEventListener('click', () => {
                const priceText = calculatedSellPriceDisplay.textContent.replace('Rp', '').replace(/\./g, '').trim();
                copyToClipboard(priceText, priceCalculatorMessageBox);
            });


            // Event Listeners for Expenses Modal
            closeExpensesModalBtn.addEventListener('click', hideExpensesModal);
            expensesModal.addEventListener('click', function(event) {
                if (event.target === expensesModal) { hideExpensesModal(); }
            });
            addExpenseBtn.addEventListener('click', addExpense);
            expenseAmountInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') { event.preventDefault(); addExpense(); }
            });
            expenseDescriptionInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') { event.preventDefault(); addExpense(); }
            });
            applyExpensesFilterBtn.addEventListener('click', function() {
                renderExpensesList(expensesDateFilterInput.value, expensesSearchInput.value);
            });
            clearExpensesFilterBtn.addEventListener('click', function() {
                expensesDateFilterInput.value = '';
                expensesSearchInput.value = '';
                renderExpensesList();
            });

            // Event Listeners for Add Product Modal
            closeAddProductModalBtn.addEventListener('click', hideAddProductModal);
            addProductModal.addEventListener('click', function(event) {
                if (event.target === addProductModal) { hideAddProductModal(); }
            });
            addNewProductBtn.addEventListener('click', addNewProduct);
            // Add keypress listeners for required fields to trigger add on Enter
            newProductCodeInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') { event.preventDefault(); addNewProduct(); }
            });
            newProductNameInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') { event.preventDefault(); addNewProduct(); }
            });
            newProductPriceInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') { event.preventDefault(); addNewProduct(); }
            });
            newProductCostInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') { event.preventDefault(); addNewProduct(); }
            });
            newProductStockInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') { event.preventDefault(); addNewProduct(); }
            });


            // Event Listeners for Store Products Modal
            closeStoreProductsModalBtn.addEventListener('click', hideStoreProductsModal);
            storeProductsModal.addEventListener('click', function(event) {
                if (event.target === storeProductsModal) { hideStoreProductsModal(); }
            });
            applyStoreProductsFilterBtn.addEventListener('click', function() {
                renderStoreProductsList(storeProductsSearchInput.value);
            });
            clearStoreProductsFilterBtn.addEventListener('click', function() {
                storeProductsSearchInput.value = '';
                renderStoreProductsList();
            });
            storeProductsSearchInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') { event.preventDefault(); renderStoreProductsList(storeProductsSearchInput.value); }
            });

            // Event Listeners for Edit Product Modal
            closeEditProductModalBtn.addEventListener('click', hideEditProductModal);
            editProductModal.addEventListener('click', function(event) {
                if (event.target === editProductModal) { hideEditProductModal(); }
            });
            saveEditedProductBtn.addEventListener('click', saveEditedProduct);
            editProductNameInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') { event.preventDefault(); saveEditedProduct(); }
            });
            editProductPriceInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') { event.preventDefault(); saveEditedProduct(); }
            });
            editProductCostInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') { event.preventDefault(); saveEditedProduct(); }
            });
            editProductStockInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') { event.preventDefault(); saveEditedProduct(); }
            });


            // === Reset All Data Button and Logic ===
            const resetAllDataBtn = document.getElementById('reset-all-data-btn');

            function resetAllApplicationData() {
                if (!loggedInUser || loggedInUser.role !== 'admin') {
                    showMessage('Anda tidak memiliki hak akses untuk fitur ini.', 'error');
                    return;
                }

                showConfirmModal('Apakah Anda YAKIN ingin menghapus SEMUA data aplikasi (pengguna, transaksi, pengeluaran, produk)? Tindakan ini TIDAK dapat dibatalkan!', () => {
                    localStorage.removeItem('transactionsHistory');
                    localStorage.removeItem('appUsers');
                    localStorage.removeItem('appExpenses');
                    localStorage.removeItem('products'); // Also remove product data
                    localStorage.removeItem('calculatedProductCodes'); // Remove calculated product codes
                    localStorage.removeItem('lastAccessDate'); // Remove last access date
                    localStorage.removeItem('darkMode'); // Remove dark mode setting

                    // Reset in-memory data
                    transactionsHistory = [];
                    appUsers = [
                        { id: 'admin1', username: 'admin', password: 'adminpass', role: 'admin' },
                        { id: 'kasir1', username: 'kasir', password: 'kasirpass', role: 'kasir' }
                    ]; // Re-initialize default users
                    appExpenses = [];
                    products = {}; // Re-initialize as empty object
                    calculatedProductCodes = []; // Re-initialize as empty array

                    localStorage.setItem('appUsers', JSON.stringify(appUsers)); // Save default users back
                    localStorage.setItem('products', JSON.stringify(products)); // Save empty products back
                    localStorage.setItem('calculatedProductCodes', JSON.stringify(calculatedProductCodes)); // Save empty calculated product codes back

                    showMessage('Semua data aplikasi telah direset! Aplikasi akan dimuat ulang.', 'success');
                    console.log("All data reset. Application will reload.");

                    // Delay briefly to allow message to be seen, then reload
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                });
            }

            resetAllDataBtn.addEventListener('click', resetAllApplicationData);

            // Event Listeners for Product Input Tabs
            tabRegisteredProductBtn.addEventListener('click', () => switchProductInputTab('registered'));
            tabCustomProductBtn.addEventListener('click', () => switchProductInputTab('custom'));

            // === New Feature Logic: Toggle Sales Visibility ===
            toggleSalesVisibilityBtn.addEventListener('click', () => {
                isSalesVisible = !isSalesVisible; // Toggle state
                if (isSalesVisible) {
                    todaySalesMainScreen.classList.remove('blur-sm'); // Remove blur
                    toggleSalesVisibilityIcon.classList.remove('fa-eye-slash'); // Change icon to eye
                    toggleSalesVisibilityIcon.classList.add('fa-eye');
                } else {
                    todaySalesMainScreen.classList.add('blur-sm'); // Add blur
                    toggleSalesVisibilityIcon.classList.remove('fa-eye'); // Change icon to eye-slash
                    toggleSalesVisibilityIcon.classList.add('fa-eye-slash');
                }
            });

            // === New Feature Logic: Toggle Dark/Light Mode ===
            toggleDarkModeBtn.addEventListener('click', () => {
                isDarkMode = !isDarkMode; // Toggle state
                if (isDarkMode) {
                    document.body.classList.add('dark-mode');
                    toggleDarkModeIcon.classList.remove('fa-lightbulb');
                    toggleDarkModeIcon.classList.add('fa-sun'); // Change icon to sun
                } else {
                    document.body.classList.remove('dark-mode');
                    toggleDarkModeIcon.classList.remove('fa-sun');
                    toggleDarkModeIcon.classList.add('fa-lightbulb'); // Change icon to lightbulb
                }
                localStorage.setItem('darkMode', isDarkMode); // Save dark mode preference
            });

            // Initial status: show login screen
            showLoginScreen();

            // Call this function when the application loads for the first time
            checkAndResetDailySales();
        });
    </script>

</body>
</html>
