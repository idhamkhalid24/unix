<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi UNIX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2e8f0; /* Light gray background for the whole page */
        }
        /* Custom styles for rounded corners on all elements */
        .rounded-xl, .rounded-lg, .rounded-md {
            border-radius: 0.75rem; /* Equivalent to Tailwind's rounded-xl */
        }
        .rounded-t-lg {
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .transition-transform {
            transition-property: transform;
            transition-duration: 0.3s;
            transition-timing-function: ease-out;
        }
        .hover\:scale-105:hover {
            transform: scale(1.05);
        }
        /* Style to prevent body scrolling when modal is open */
        body.overflow-hidden {
            overflow: hidden;
        }
    </style>
</head>
<body class="p-4 lg:p-8 flex items-center justify-center min-h-screen">

    <script type="module">
        let userId = null; // Stored locally for consistency
        let loggedInUser = null; // Our user object from localStorage (username, role)

        document.addEventListener('DOMContentLoaded', async function() {
            // References to main UI elements
            const loginScreen = document.getElementById('login-screen');
            const mainAppContainer = document.getElementById('main-app-container');
            const cashierNameSpan = document.getElementById('cashier-name');
            const todaySalesMainScreen = document.getElementById('today-sales-main-screen');
            const adminMenuToggle = document.getElementById('admin-menu-toggle');
            const adminMenuDropdown = document.getElementById('admin-menu-dropdown');
            const adminMenuContainer = document.getElementById('admin-menu-container');
            const logoutBtn = document.getElementById('logout-btn');

            // Login Screen elements
            const loginUsernameInput = document.getElementById('login-username');
            const loginPasswordInput = document.getElementById('login-password');
            const loginBtn = document.getElementById('login-btn');
            const loginMessage = document.getElementById('login-message');

            // User Settings Modal elements
            const openUserSettingsModalBtn = document.getElementById('open-user-settings-modal-btn');
            const userSettingsModal = document.getElementById('user-settings-modal');
            const closeUserSettingsModalBtn = document.getElementById('close-user-settings-modal-btn');
            const userListBody = document.getElementById('user-list-body');
            const newUsernameInput = document.getElementById('new-username');
            const newPasswordInput = document.getElementById('new-password');
            const newUserRoleSelect = document.getElementById('new-user-role');
            const addUserBtn = document.getElementById('add-user-btn');
            const userSettingsMessageBox = document.getElementById('user-settings-message-box');

            // Export/Import Data elements
            const exportDataBtn = document.getElementById('export-data-btn');
            const importDataBtn = document.getElementById('import-data-btn');
            const importFileInput = document.getElementById('import-file-input');

            // Price Calculator Modal elements
            const openPriceCalculatorBtn = document.getElementById('open-price-calculator-btn');
            const priceCalculatorModal = document.getElementById('price-calculator-modal');
            const closePriceCalculatorModalBtn = document.getElementById('close-price-calculator-modal-btn');
            const productCodeCalcInput = document.getElementById('product-code-calc');
            const productNameCalcInput = document.getElementById('product-name-calc');
            const modalPriceCalcInput = document.getElementById('modal-price-calc');
            const marginPercentCalcInput = document.getElementById('margin-percent-calc');
            const calculateSellPriceBtn = document.getElementById('calculate-sell-price-btn');
            const calculatedSellPriceDisplay = document.getElementById('calculated-sell-price-display');
            const calculatedProfitDisplay = document.getElementById('calculated-profit-display'); // NEW: Profit display
            const priceCalculatorMessageBox = document.getElementById('price-calculator-message-box');


            // Existing application elements
            const currentDateSpan = document.getElementById('current-date');
            const productCodeInput = document.getElementById('product-code');
            const productNameInput = document.getElementById('product-name');
            const priceInput = document.getElementById('price');
            const quantityInput = document.getElementById('quantity');
            const addCustomProductBtn = document.getElementById('add-custom-product-btn');
            const clearProductsBtn = document.getElementById('clear-products-btn');
            const paymentModal = document.getElementById('payment-modal');
            const closePaymentModalBtn = document.getElementById('close-payment-modal-btn');
            const subtotalSpan = document.getElementById('subtotal');
            const discountInput = document.getElementById('discount-input');
            const grandTotalSpan = document.getElementById('grand-total');
            const paymentMethodSelect = document.getElementById('payment-method-select');
            const amountReceivedInput = document.getElementById('amount-received');
            const changeSpan = document.getElementById('change');
            const processTransactionBtn = document.getElementById('process-transaction-btn');
            const messageBox = document.getElementById('message-box');
            const openTransactionHistoryModalBtn = document.getElementById('open-transaction-history-modal-btn');
            const transactionHistoryModal = document.getElementById('transaction-history-modal');
            const closeTransactionHistoryModalBtn = document.getElementById('close-transaction-history-modal-btn');
            const transactionHistoryTableBody = document.getElementById('transaction-history-items');
            const emptyHistoryMessage = document.getElementById('empty-history-message');
            const transactionDateFilterInput = document.getElementById('transaction-date-filter');
            const applyTransactionFilterBtn = document.getElementById('apply-transaction-filter-btn');
            const clearTransactionFilterBtn = document.getElementById('clear-transaction-filter-btn');

            let cart = []; // Array to store products in the current transaction

            const products = { // Simple mock product database
                'P001': { name: 'Kopi Susu', price: 15000 },
                'P002': { name: 'Roti Bakar', price: 12000 },
                'P003': { name: 'Es Teh', price: 8000 },
                'P004': { name: 'Nasi Goreng', price: 25000 },
                'P005': { name: 'Mie Ayam', price: 20000 }
            };


            // --- Custom Confirmation Modal Elements ---
            const confirmModal = document.createElement('div');
            confirmModal.id = 'custom-confirm-modal';
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50';
            confirmModal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-sm mx-auto">
                    <p id="confirm-message" class="text-lg text-gray-800 mb-6 text-center"></p>
                    <div class="flex justify-around gap-4">
                        <button id="confirm-yes-btn" class="bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded-lg font-semibold w-full transition duration-200 hover:scale-105">Ya</button>
                        <button id="confirm-no-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-5 py-2 rounded-lg font-semibold w-full transition duration-200 hover:scale-105">Tidak</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);

            const confirmMessage = document.getElementById('confirm-message');
            const confirmYesBtn = document.getElementById('confirm-yes-btn');
            const confirmNoBtn = document.getElementById('confirm-no-btn');
            let confirmCallback = null; // To store the callback function for confirmation


            // --- Local Storage Data Management ---
            let transactionsHistory = JSON.parse(localStorage.getItem('transactionsHistory')) || [];
            let appUsers = JSON.parse(localStorage.getItem('appUsers')) || [];

            // Initialize default admin/kasir users if none exist
            if (appUsers.length === 0) {
                appUsers = [
                    { id: 'admin1', username: 'admin', password: 'adminpass', role: 'admin' },
                    { id: 'kasir1', username: 'kasir', password: 'kasirpass', role: 'kasir' }
                ];
                localStorage.setItem('appUsers', JSON.stringify(appUsers));
                console.log("Default users initialized:", appUsers); // Log default users
            } else {
                console.log("Users loaded from localStorage:", appUsers); // Log loaded users
            }


            // --- UI State Management ---
            function showLoginScreen() {
                loginScreen.classList.remove('hidden');
                mainAppContainer.classList.add('hidden');
                userSettingsModal.classList.add('hidden');
                paymentModal.classList.add('hidden');
                transactionHistoryModal.classList.add('hidden');
                priceCalculatorModal.classList.add('hidden'); // Hide price calculator modal
                document.body.classList.remove('overflow-hidden');
                loggedInUser = null; // Ensure loggedInUser is null when showing login screen
                loginUsernameInput.value = ''; // Clear username input
                loginPasswordInput.value = ''; // Clear password input
                loginMessage.classList.add('hidden'); // Hide any login messages
            }

            function showMainApp() {
                loginScreen.classList.add('hidden');
                mainAppContainer.classList.remove('hidden');
                // Hide admin menu if not admin
                if (loggedInUser && loggedInUser.role === 'admin') {
                    adminMenuContainer.classList.remove('hidden');
                    console.log("Admin menu SHOWN for user:", loggedInUser.username, "Role:", loggedInUser.role);
                } else {
                    adminMenuContainer.classList.add('hidden');
                    console.log("Admin menu HIDDEN for user:", loggedInUser ? loggedInUser.username : 'No User', "Role:", loggedInUser ? loggedInUser.role : 'N/A');
                }
                updateTodaySalesDisplay();
                updateCurrentDate(); // Call to update the date
            }

            function showMessage(message, type = 'info') {
                messageBox.textContent = message;
                messageBox.classList.remove('hidden', 'bg-red-100', 'border-red-200', 'text-red-800', 'bg-green-100', 'border-green-200', 'text-green-800', 'bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                if (type === 'error') {
                    messageBox.classList.add('bg-red-100', 'border-red-200', 'text-red-800');
                } else if (type === 'success') {
                    messageBox.classList.add('bg-green-100', 'border-green-200', 'text-green-800');
                } else {
                    messageBox.classList.add('bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                }
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 3000); // Hide after 3 seconds
            }

            function showUserSettingsMessage(message, type = 'info') {
                userSettingsMessageBox.textContent = message;
                userSettingsMessageBox.classList.remove('hidden', 'bg-red-100', 'border-red-200', 'text-red-800', 'bg-green-100', 'border-green-200', 'text-green-800', 'bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                if (type === 'error') {
                    userSettingsMessageBox.classList.add('bg-red-100', 'border-red-200', 'text-red-800');
                } else if (type === 'success') {
                    userSettingsMessageBox.classList.add('bg-green-100', 'border-green-200', 'text-green-800');
                } else {
                    userSettingsMessageBox.classList.add('bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                }
                setTimeout(() => {
                    userSettingsMessageBox.classList.add('hidden');
                }, 3000);
            }

            function showPriceCalculatorMessage(message, type = 'info') {
                priceCalculatorMessageBox.textContent = message;
                priceCalculatorMessageBox.classList.remove('hidden', 'bg-red-100', 'border-red-200', 'text-red-800', 'bg-green-100', 'border-green-200', 'text-green-800', 'bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                if (type === 'error') {
                    priceCalculatorMessageBox.classList.add('bg-red-100', 'border-red-200', 'text-red-800');
                } else if (type === 'success') {
                    priceCalculatorMessageBox.classList.add('bg-green-100', 'border-green-200', 'text-green-800');
                } else {
                    priceCalculatorMessageBox.classList.add('bg-yellow-100', 'border-yellow-200', 'text-yellow-800');
                }
                setTimeout(() => {
                    priceCalculatorMessageBox.classList.add('hidden');
                }, 3000);
            }

            function formatCurrency(amount) {
                return new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    minimumFractionDigits: 0
                }).format(amount);
            }

            // Function to update the current date display
            function updateCurrentDate() {
                const now = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                currentDateSpan.textContent = `Tanggal: ${now.toLocaleDateString('id-ID', options)}`;
            }

            // --- Custom Confirmation Modal Functions ---
            function showConfirmModal(message, onConfirm) {
                confirmMessage.textContent = message;
                confirmCallback = onConfirm;
                confirmModal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            }

            function hideConfirmModal() {
                confirmModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
                confirmCallback = null;
            }

            confirmYesBtn.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                hideConfirmModal();
            });

            confirmNoBtn.addEventListener('click', () => {
                hideConfirmModal();
            });

            // --- Login Logic (using localStorage) ---
            loginBtn.addEventListener('click', async () => {
                const username = loginUsernameInput.value.trim();
                const password = loginPasswordInput.value.trim();

                if (!username || !password) {
                    loginMessage.textContent = 'Nama pengguna dan Kata Sandi tidak boleh kosong.';
                    loginMessage.classList.remove('hidden');
                    return;
                }
                loginMessage.classList.add('hidden');

                const foundUser = appUsers.find(user => user.username === username && user.password === password);

                if (foundUser) {
                    loggedInUser = { ...foundUser }; // Copy user data
                    userId = foundUser.id; // Set local userId
                    console.log("Login successful. LoggedInUser:", loggedInUser);
                    cashierNameSpan.textContent = `Kasir: ${loggedInUser.username} (${loggedInUser.role})`;
                    showMainApp();
                } else {
                    loginMessage.textContent = 'Nama pengguna atau kata sandi salah.';
                    loginMessage.classList.remove('hidden');
                }
            });

            // --- Logout Logic (using localStorage) ---
            logoutBtn.addEventListener('click', async () => {
                showConfirmModal('Apakah Anda yakin ingin logout?', async () => {
                    loggedInUser = null; // Clear our internal user state
                    cart = []; // Clear cart on logout
                    console.log("User logged out.");
                    showLoginScreen(); // Show login screen
                });
            });

            // --- User Settings Modal Logic (using localStorage) ---
            openUserSettingsModalBtn.addEventListener('click', () => {
                if (!loggedInUser || loggedInUser.role !== 'admin') {
                    showMessage('Anda tidak memiliki hak akses untuk fitur ini.', 'error');
                    return;
                }
                userSettingsModal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
                renderUserList();
            });

            closeUserSettingsModalBtn.addEventListener('click', () => {
                userSettingsModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            });

            function renderUserList() {
                userListBody.innerHTML = '';
                if (appUsers.length === 0) {
                    userListBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-500">Tidak ada pengguna.</td></tr>`;
                    return;
                }

                appUsers.forEach(user => {
                    const row = userListBody.insertRow();
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.username}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.role}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            ${(loggedInUser && user.id !== loggedInUser.id) ? `<button data-id="${user.id}" class="text-red-600 hover:text-red-900 ml-4 delete-user-btn">Hapus</button>` : `<span class="text-gray-400">Anda</span>`}
                        </td>
                    `;
                });

                document.querySelectorAll('.delete-user-btn').forEach(button => {
                    button.addEventListener('click', deleteUser);
                });
            }

            addUserBtn.addEventListener('click', async () => {
                const username = newUsernameInput.value.trim();
                const password = newPasswordInput.value.trim();
                const role = newUserRoleSelect.value;

                if (!username || !password) {
                    showUserSettingsMessage('Nama pengguna dan Kata Sandi tidak boleh kosong.', 'error');
                    return;
                }
                if (password.length < 3) { // Minimal password length for demo
                    showUserSettingsMessage('Kata sandi harus minimal 3 karakter.', 'error');
                    return;
                }

                // Check if username already exists
                const existingUser = appUsers.find(user => user.username === username);
                if (existingUser) {
                    showUserSettingsMessage('Nama pengguna sudah ada. Pilih nama lain.', 'error');
                    return;
                }

                const newUserId = 'user_' + Date.now(); // Simple unique ID
                appUsers.push({ id: newUserId, username: username, password: password, role: role });
                localStorage.setItem('appUsers', JSON.stringify(appUsers));
                console.log("User added. Current appUsers:", appUsers);

                showUserSettingsMessage('Pengguna berhasil ditambahkan!', 'success');
                newUsernameInput.value = ''; // Clear input
                newPasswordInput.value = ''; // Clear password input
                newUserRoleSelect.value = 'kasir'; // Reset dropdown
                renderUserList(); // Re-render list
            });

            async function deleteUser(event) {
                const userIdToDelete = event.target.dataset.id;
                showConfirmModal(`Apakah Anda yakin ingin menghapus pengguna ini?`, async () => {
                    // Prevent deleting the currently logged-in user
                    if (loggedInUser && loggedInUser.id === userIdToDelete) {
                        showUserSettingsMessage('Tidak dapat menghapus pengguna yang sedang login.', 'error');
                        return;
                    }

                    appUsers = appUsers.filter(user => user.id !== userIdToDelete);
                    localStorage.setItem('appUsers', JSON.stringify(appUsers));
                    console.log("User deleted. Current appUsers:", appUsers);
                    showUserSettingsMessage('Pengguna berhasil dihapus!', 'success');
                    renderUserList(); // Re-render list
                });
            }

            // --- Export/Import Data Functions ---
            function exportData() {
                if (!loggedInUser || loggedInUser.role !== 'admin') {
                    showMessage('Anda tidak memiliki hak akses untuk mengekspor data.', 'error');
                    return;
                }

                showConfirmModal('Apakah Anda yakin ingin mengekspor semua data aplikasi (pengguna & riwayat transaksi)?', () => {
                    const dataToExport = {
                        appUsers: appUsers,
                        transactionsHistory: transactionsHistory
                    };
                    const dataStr = JSON.stringify(dataToExport, null, 2); // Pretty print JSON

                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `unix_app_data_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showMessage('Data berhasil diekspor!', 'success');
                });
            }

            function importData() {
                if (!loggedInUser || loggedInUser.role !== 'admin') {
                    showMessage('Anda tidak memiliki hak akses untuk mengimpor data.', 'error');
                    return;
                }
                // Trigger the hidden file input click
                importFileInput.click();
            }

            importFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) {
                    showMessage('Tidak ada file yang dipilih.', 'info');
                    return;
                }

                if (file.type !== 'application/json') {
                    showMessage('Hanya file JSON (.json) yang diizinkan untuk diimpor.', 'error');
                    return;
                }

                showConfirmModal('Apakah Anda yakin ingin mengimpor data? Ini akan MENIMPA data yang ada saat ini.', () => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importedData = JSON.parse(e.target.result);

                            if (importedData.appUsers && Array.isArray(importedData.appUsers)) {
                                appUsers = importedData.appUsers;
                                localStorage.setItem('appUsers', JSON.stringify(appUsers));
                                console.log('Users imported successfully.');
                            } else {
                                console.warn('No valid appUsers found in imported file, skipping user import.');
                            }

                            if (importedData.transactionsHistory && Array.isArray(importedData.transactionsHistory)) {
                                transactionsHistory = importedData.transactionsHistory;
                                localStorage.setItem('transactionsHistory', JSON.stringify(transactionsHistory));
                                console.log('Transactions imported successfully.');
                            } else {
                                console.warn('No valid transactionsHistory found in imported file, skipping transaction import.');
                            }

                            showMessage('Data berhasil diimpor dan diperbarui! Harap segarkan halaman untuk melihat perubahan.', 'success');
                            // Optionally, reload the page to ensure all data is re-rendered
                            // location.reload();
                            renderUserList(); // Re-render user list
                            renderTransactionHistory(); // Re-render transaction history
                            updateTodaySalesDisplay(); // Update today sales
                        } catch (error) {
                            showMessage('Gagal mengurai file JSON. Pastikan format file benar.', 'error');
                            console.error('Error importing data:', error);
                        }
                    };
                    reader.readAsText(file);
                });
            });

            // --- Price Calculator Functions ---
            function openPriceCalculatorModal() {
                if (!loggedInUser || loggedInUser.role !== 'admin') {
                    showMessage('Anda tidak memiliki hak akses untuk fitur ini.', 'error');
                    return;
                }
                priceCalculatorModal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
                // Clear previous values
                productCodeCalcInput.value = '';
                productNameCalcInput.value = '';
                modalPriceCalcInput.value = '';
                marginPercentCalcInput.value = '';
                calculatedSellPriceDisplay.textContent = formatCurrency(0);
                calculatedProfitDisplay.textContent = formatCurrency(0); // NEW: Clear profit display
                priceCalculatorMessageBox.classList.add('hidden');
            }

            function hidePriceCalculatorModal() {
                priceCalculatorModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }

            function calculateSellPrice() {
                const modalPrice = parseFloat(modalPriceCalcInput.value);
                const marginPercent = parseFloat(marginPercentCalcInput.value);

                if (isNaN(modalPrice) || modalPrice < 0) {
                    showPriceCalculatorMessage('Modal harus angka positif.', 'error');
                    calculatedSellPriceDisplay.textContent = formatCurrency(0);
                    calculatedProfitDisplay.textContent = formatCurrency(0); // NEW: Reset profit
                    return;
                }
                if (isNaN(marginPercent) || marginPercent < 0) {
                    showPriceCalculatorMessage('Margin harus angka positif.', 'error');
                    calculatedSellPriceDisplay.textContent = formatCurrency(0);
                    calculatedProfitDisplay.textContent = formatCurrency(0); // NEW: Reset profit
                    return;
                }

                const sellingPrice = modalPrice + (modalPrice * (marginPercent / 100));
                const profit = sellingPrice - modalPrice; // Calculate profit

                calculatedSellPriceDisplay.textContent = formatCurrency(sellingPrice);
                calculatedProfitDisplay.textContent = formatCurrency(profit); // Display profit
                showPriceCalculatorMessage('Harga jual dan keuntungan berhasil dihitung!', 'success');
            }


            // --- Existing Application Functions (adapted for localStorage) ---
            function showPaymentModal() {
                paymentModal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden'); // Prevent background scrolling
            }

            function hidePaymentModal() {
                paymentModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden'); // Re-enable background scrolling
            }

            function showTransactionHistoryModal() {
                // When opening the history modal, render all transactions by default
                renderTransactionHistory();
                transactionHistoryModal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            }

            function hideTransactionHistoryModal() {
                transactionHistoryModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }

            function updateSummary() {
                let currentSubtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                let discount = parseFloat(discountInput.value) || 0; // Get discount value

                // Ensure discount does not make total negative
                if (discount > currentSubtotal) {
                    discount = currentSubtotal; // Discount cannot exceed subtotal
                    discountInput.value = discount; // Update input field
                }

                let currentGrandTotal = currentSubtotal - discount; // Subtract discount

                subtotalSpan.textContent = formatCurrency(currentGrandTotal);
                grandTotalSpan.textContent = formatCurrency(currentGrandTotal);

                // Update change calculation
                calculateChange();

                // Hide modal if cart is empty, otherwise ensure it's shown if triggered by add product
                if (cart.length === 0) {
                    hidePaymentModal();
                }
            }

            function calculateChange() {
                const grandTotalStr = grandTotalSpan.textContent.replace('Rp', '').replace(/\./g, '').trim();
                const grandTotal = parseFloat(grandTotalStr) || 0;
                const amountReceived = parseFloat(amountReceivedInput.value) || 0;
                const change = amountReceived - grandTotal;
                changeSpan.textContent = formatCurrency(change);
                changeSpan.classList.toggle('text-red-600', change < 0);
                changeSpan.classList.toggle('text-blue-600', change >= 0);
            }

            function addProductByCode() {
                const productCode = productCodeInput.value.trim().toUpperCase();
                const quantity = parseInt(quantityInput.value);

                if (!productCode || quantity <= 0) {
                    showMessage('Harap masukkan Kode Produk dan kuantitas yang valid.', 'error');
                    return;
                }

                const product = products[productCode];
                if (product) {
                    const existingItemIndex = cart.findIndex(item => item.id === productCode);
                    if (existingItemIndex > -1) {
                        cart[existingItemIndex].quantity += quantity;
                    } else {
                        cart.push({ id: productCode, name: product.name, price: product.price, quantity: quantity });
                    }
                    productCodeInput.value = ''; // Clear input
                    productNameInput.value = ''; // Clear manual input as well
                    priceInput.value = '0'; // Reset price
                    quantityInput.value = '1'; // Reset quantity
                    updateSummary(); // Update summary
                    showMessage(`Produk "${product.name}" ditambahkan.`, 'success');
                    showPaymentModal(); // Show modal after adding product
                } else {
                    showMessage('Produk dengan kode tersebut tidak ditemukan.', 'error');
                }
            }

            function addCustomProduct() {
                const productName = productNameInput.value.trim();
                const price = parseFloat(priceInput.value);
                const quantity = parseInt(quantityInput.value);

                if (!productName || isNaN(price) || price < 0 || isNaN(quantity) || quantity <= 0) {
                    showMessage('Harap masukkan Nama Produk, Harga, dan Kuantitas yang valid.', 'error');
                    return;
                }

                const newProductId = 'CUSTOM_' + Date.now(); // Unique ID for custom product
                cart.push({ id: newProductId, name: productName, price: price, quantity: quantity });

                productCodeInput.value = ''; // Clear code input
                productNameInput.value = ''; // Clear name input
                priceInput.value = '0'; // Reset price
                quantityInput.value = '1'; // Reset quantity
                updateSummary(); // Update summary
                showMessage(`Produk kustom "${productName}" ditambahkan.`, 'success');
                showPaymentModal(); // Show modal after adding product
            }

            function clearCart() {
                if (cart.length > 0) {
                    cart = [];
                    updateSummary(); // Update summary and hide section if cart is empty
                    showMessage('Keranjang belanja dikosongkan.', 'info');
                    amountReceivedInput.value = ''; // Clear amount received
                    discountInput.value = '0'; // Reset discount
                }
            }

            async function processTransaction() {
                if (cart.length === 0) {
                    showMessage('Keranjang kosong. Tidak ada transaksi untuk diproses.', 'error');
                    return;
                }

                const grandTotal = parseFloat(grandTotalSpan.textContent.replace('Rp', '').replace(/\./g, '').trim()) || 0;
                const amountReceived = parseFloat(amountReceivedInput.value) || 0;
                const selectedPaymentMethod = paymentMethodSelect.value;

                if (amountReceived < grandTotal) {
                    showMessage('Jumlah uang diterima tidak mencukupi.', 'error');
                    return;
                }

                const transaction = {
                    id: 'TRX-' + Date.now(), // Generate a local ID for offline
                    dateDisplay: new Date().toLocaleString('id-ID', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }),
                    dateForComparison: new Date().toISOString().slice(0, 10),
                    total: grandTotal,
                    subtotal: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                    discount: parseFloat(discountInput.value) || 0,
                    paymentMethod: selectedPaymentMethod,
                    amountReceived: amountReceived,
                    change: amountReceived - grandTotal,
                    items: JSON.parse(JSON.stringify(cart)),
                    cashierId: loggedInUser ? loggedInUser.id : 'anonymous',
                    cashierUsername: loggedInUser ? loggedInUser.username : 'Anonim'
                };

                transactionsHistory.push(transaction);
                localStorage.setItem('transactionsHistory', JSON.stringify(transactionsHistory)); // Save to localStorage

                showMessage('Transaksi berhasil diproses!', 'success');
                console.log('Transaksi diproses:', transaction);
                clearCart();
                amountReceivedInput.value = '';
                changeSpan.textContent = formatCurrency(0);
                updateTodaySalesDisplay(); // Update main screen sales
            }

            function renderTransactionHistory(filterDate = null) {
                transactionHistoryTableBody.innerHTML = '';
                let filteredHistory = transactionsHistory;
                if (filterDate) {
                    filteredHistory = transactionsHistory.filter(trans => {
                        const transDate = trans.dateForComparison || (new Date(trans.dateDisplay).toISOString().slice(0, 10));
                        return transDate === filterDate;
                    });
                }

                if (filteredHistory.length === 0) {
                    emptyHistoryMessage.classList.remove('hidden');
                } else {
                    emptyHistoryMessage.classList.add('hidden');
                    const sortedHistory = [...filteredHistory].sort((a, b) => new Date(b.dateDisplay) - new Date(a.dateDisplay));
                    sortedHistory.forEach(transaction => {
                        const row = transactionHistoryTableBody.insertRow();
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${transaction.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${transaction.dateDisplay}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(transaction.total)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${transaction.paymentMethod}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button data-id="${transaction.id}" class="text-red-600 hover:text-red-900 delete-transaction-btn">Hapus</button>
                            </td>
                        `;
                    });
                    document.querySelectorAll('.delete-transaction-btn').forEach(button => {
                        button.addEventListener('click', deleteTransaction);
                    });
                }
            }

            async function deleteTransaction(event) {
                const transactionIdToDelete = String(event.target.dataset.id);
                showConfirmModal(`Apakah Anda yakin ingin menghapus transaksi dengan ID ${transactionIdToDelete}?`, async () => {
                    transactionsHistory = transactionsHistory.filter(trans => trans.id !== transactionIdToDelete);
                    localStorage.setItem('transactionsHistory', JSON.stringify(transactionsHistory)); // Save to localStorage
                    showMessage(`Transaksi ${transactionIdToDelete} telah dihapus.`, 'info');
                    renderTransactionHistory(transactionDateFilterInput.value || null); // Re-render history
                    updateTodaySalesDisplay(); // Update sales
                });
            }

            function updateTodaySalesDisplay() {
                const todayFormatted = new Date().toISOString().slice(0, 10);
                let totalSalesToday = 0;
                transactionsHistory.forEach(transaction => {
                    let transactionDateForComparison = transaction.dateForComparison;
                    if (!transactionDateForComparison && transaction.dateDisplay) {
                        const parsedDate = new Date(transaction.dateDisplay);
                        if (!isNaN(parsedDate.getTime())) {
                            transactionDateForComparison = parsedDate.toISOString().slice(0, 10);
                        } else {
                            console.warn('Invalid dateDisplay encountered, skipping transaction for sales calculation:', transaction.dateDisplay);
                            return;
                        }
                    }
                    if (transactionDateForComparison === todayFormatted) {
                        totalSalesToday += transaction.total;
                    }
                });
                todaySalesMainScreen.textContent = formatCurrency(totalSalesToday);
            }

            // --- Event Listeners ---
            productCodeInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') { event.preventDefault(); addProductByCode(); }
            });
            addCustomProductBtn.addEventListener('click', addCustomProduct);
            productNameInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') { event.preventDefault(); addCustomProduct(); }
            });
            priceInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') { event.preventDefault(); addCustomProduct(); }
            });
            quantityInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') { event.preventDefault(); addCustomProduct(); }
            });
            clearProductsBtn.addEventListener('click', clearCart);

            paymentModal.addEventListener('click', function(event) {
                if (event.target === paymentModal) { hidePaymentModal(); }
            });
            closePaymentModalBtn.addEventListener('click', hidePaymentModal);
            discountInput.addEventListener('input', updateSummary);
            amountReceivedInput.addEventListener('input', calculateChange);
            amountReceivedInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter' && !paymentModal.classList.contains('hidden')) { event.preventDefault(); processTransaction(); }
            });
            processTransactionBtn.addEventListener('click', processTransaction);

            openTransactionHistoryModalBtn.addEventListener('click', showTransactionHistoryModal);
            closeTransactionHistoryModalBtn.addEventListener('click', hideTransactionHistoryModal);
            transactionHistoryModal.addEventListener('click', function(event) {
                if (event.target === transactionHistoryModal) { hideTransactionHistoryModal(); }
            });

            applyTransactionFilterBtn.addEventListener('click', function() {
                const filterDate = transactionDateFilterInput.value;
                renderTransactionHistory(filterDate);
            });
            clearTransactionFilterBtn.addEventListener('click', function() {
                transactionDateFilterInput.value = '';
                renderTransactionHistory();
            });

            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    if (!paymentModal.classList.contains('hidden')) { hidePaymentModal(); }
                    if (!transactionHistoryModal.classList.contains('hidden')) { hideTransactionHistoryModal(); }
                    if (!userSettingsModal.classList.contains('hidden')) { userSettingsModal.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); }
                    if (!priceCalculatorModal.classList.contains('hidden')) { hidePriceCalculatorModal(); } // Close price calculator modal
                    if (!confirmModal.classList.contains('hidden')) { hideConfirmModal(); } // Close confirm modal
                }
            });

            // Toggle Admin Menu Dropdown
            adminMenuToggle.addEventListener('click', function() {
                adminMenuDropdown.classList.toggle('hidden');
            });

            // Close the dropdown if the user clicks outside of it
            window.addEventListener('click', function(event) {
                if (!adminMenuContainer.contains(event.target)) {
                    adminMenuDropdown.classList.add('hidden');
                }
            });

            // Admin Menu Button Listeners (for demonstration)
            openPriceCalculatorBtn.addEventListener('click', openPriceCalculatorModal); // Changed from simple message to open modal
            document.getElementById('open-expenses-modal-btn').addEventListener('click', () => {
                if (!loggedInUser || loggedInUser.role !== 'admin') { showMessage('Anda tidak memiliki hak akses untuk fitur ini.', 'error'); return; }
                showMessage('Fungsi Pengeluaran akan segera hadir!', 'info');
            });
            document.getElementById('open-financial-report-modal-btn').addEventListener('click', () => {
                if (!loggedInUser || loggedInUser.role !== 'admin') { showMessage('Anda tidak memiliki hak akses untuk fitur ini.', 'error'); return; }
                showMessage('Fungsi Laporan Keuangan akan segera hadir!', 'info');
            });
            document.getElementById('open-product-management-modal-btn').addEventListener('click', () => {
                if (!loggedInUser || loggedInUser.role !== 'admin') { showMessage('Anda tidak memiliki hak akses untuk fitur ini.', 'error'); return; }
                showMessage('Fungsi Manajemen Produk akan segera hadir!', 'info');
            });
            document.getElementById('open-store-products-modal-btn').addEventListener('click', () => {
                if (!loggedInUser || loggedInUser.role !== 'admin') { showMessage('Anda tidak memiliki hak akses untuk fitur ini.', 'error'); return; }
                showMessage('Fungsi Produk Toko akan segera hadir!', 'info');
            });

            // New Event Listeners for Export/Import
            exportDataBtn.addEventListener('click', exportData);
            importDataBtn.addEventListener('click', importData);

            // New Event Listeners for Price Calculator Modal
            closePriceCalculatorModalBtn.addEventListener('click', hidePriceCalculatorModal);
            priceCalculatorModal.addEventListener('click', function(event) {
                if (event.target === priceCalculatorModal) { hidePriceCalculatorModal(); }
            });
            calculateSellPriceBtn.addEventListener('click', calculateSellPrice);
            // Allow Enter key to trigger calculation in price calculator modal
            modalPriceCalcInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') { event.preventDefault(); calculateSellPrice(); }
            });
            marginPercentCalcInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') { event.preventDefault(); calculateSellPrice(); }
            });


            // Initial state: show login screen
            showLoginScreen();
        });
    </script>

<div id="login-screen" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm text-center">
            <h2 class="text-3xl font-bold text-green-700 mb-8">بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيْمِ</h2>
            <div class="mb-4">
                <label for="login-username" class="block text-gray-700 text-sm font-medium mb-2 text-left">Nama Pengguna:</label>
                <input type="text" id="login-username" placeholder="Masukkan nama pengguna"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200">
            </div>
            <div class="mb-6">
                <label for="login-password" class="block text-gray-700 text-sm font-medium mb-2 text-left">Kata Sandi:</label>
                <input type="password" id="login-password" placeholder="Masukkan kata sandi"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200">
            </div>
            <button id="login-btn"
                    class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105 w-full">
                Login
            </button>
            <div id="login-message" class="mt-4 p-3 bg-red-100 border border-red-200 text-red-800 rounded-md hidden"></div>
        </div>
    </div>

    <div id="main-app-container" class="container mx-auto p-4 lg:p-8 bg-gray-50 rounded-xl shadow-lg my-8 flex flex-col hidden">
        <header class="flex flex-col lg:flex-row justify-between items-center bg-green-600 text-white p-6 rounded-t-lg shadow-md relative">
            <h1 class="text-3xl lg:text-4xl font-bold mb-3 lg:mb-0"><b><i>UNIX</i></b></h1>
            <div class="flex-grow flex flex-col lg:flex-row lg:justify-end items-center lg:items-end gap-4 mt-4 lg:mt-0">
                <div class="text-sm opacity-90 text-center lg:text-right">
                    <span id="cashier-name" class="block">Kasir: Nama Kasir</span>
                    <span id="current-date" class="block">Tanggal: 17 Juni 2025</span>
                </div>
                <div class="text-right text-xl font-bold mt-2 lg:mt-0 lg:ml-auto">
                    <span id="today-sales-main-screen" class="block text-3xl">Rp 0</span>
                </div>
                <nav class="mt-4 lg:mt-0 flex gap-4">
                    <button id="open-transaction-history-modal-btn"
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition duration-200 shadow-sm hover:scale-105">
                        Riwayat Transaksi
                    </button>
                    <div class="relative inline-block text-left" id="admin-menu-container">
                        <button type="button" id="admin-menu-toggle" class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 focus:ring-green-500 hover:scale-105 transition-transform" aria-expanded="true" aria-haspopup="true">
                            Menu Admin
                            <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 011.414 1.414l-4 4a1 1 01-1.414 0l-4-4a1 1 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div id="admin-menu-dropdown" class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-50" role="menu" aria-orientation="vertical" aria-labelledby="menu-button" tabindex="-1">
                            <div class="py-1" role="none">
                                <button id="open-price-calculator-btn" class="text-gray-700 block px-4 py-2 text-sm w-full text-left hover:bg-gray-100" role="menuitem" tabindex="-1">FIX PRICE</button>
                                <button id="open-expenses-modal-btn" class="text-gray-700 block px-4 py-2 text-sm w-full text-left hover:bg-gray-100" role="menuitem" tabindex="-1">Pengeluaran</button>
                                <button id="open-user-settings-modal-btn" class="text-gray-700 block px-4 py-2 text-sm w-full text-left hover:bg-gray-100" role="menuitem" tabindex="-1">Pengaturan Pengguna</button>
                                <button id="open-financial-report-modal-btn" class="text-gray-700 block px-4 py-2 text-sm w-full text-left hover:bg-gray-100" role="menuitem" tabindex="-1">Laporan Keuangan</button>
                                <button id="open-product-management-modal-btn" class="text-gray-700 block px-4 py-2 text-sm w-full text-left hover:bg-gray-100" role="menuitem" tabindex="-1">Manajemen Produk</button>
                                <button id="open-store-products-modal-btn" class="text-gray-700 block px-4 py-2 text-sm w-full text-left hover:bg-gray-100" role="menuitem" tabindex="-1">Produk Toko</button>
                                <hr class="my-1 border-gray-200"> <button id="export-data-btn" class="text-green-700 block px-4 py-2 text-sm w-full text-left hover:bg-gray-100 font-semibold" role="menuitem" tabindex="-1">Ekspor Data</button>
                                <input type="file" id="import-file-input" accept=".json" class="hidden"> <button id="import-data-btn" class="text-blue-700 block px-4 py-2 text-sm w-full text-left hover:bg-gray-100 font-semibold" role="menuitem" tabindex="-1">Impor Data</button>
                            </div>
                        </div>
                    </div>
                    <button id="logout-btn"
                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition duration-200 shadow-sm hover:scale-105">
                        Logout
                    </button>
                </nav>
            </div>
        </header>

        <main class="flex-grow p-6 bg-white rounded-b-lg flex flex-col lg:flex-row gap-6">
            <section class="lg:w-full bg-gray-50 p-6 rounded-lg shadow-md flex flex-col">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 pb-3 border-b-2 border-gray-200">Input Produk</h2>

                <div class="mb-4">
                    <label for="product-code" class="block text-gray-700 text-sm font-medium mb-2">Kode Produk (Opsional):</label>
                    <div class="flex">
                        <input type="text" id="product-code" placeholder="Scan atau ketik kode produk"
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200">
                    </div>
                </div>

                <div class="mb-4">
                    <label for="product-name" class="block text-gray-700 text-sm font-medium mb-2">Nama Produk (Wajib):</label>
                    <input type="text" id="product-name"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200 text-gray-800" placeholder="Ketik nama produk">
                </div>

                <div class="mb-4">
                    <label for="price" class="block text-gray-700 text-sm font-medium mb-2">Harga:</label>
                    <input type="text" id="price" placeholder="Masukkan harga" value="0"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200">
                </div>

                <div class="mb-6">
                    <label for="quantity" class="block text-gray-700 text-sm font-medium mb-2">Jumlah:</label>
                    <input type="number" id="quantity" value="1" min="1"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200">
                </div>

                <button id="add-custom-product-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105 w-full mb-6">
                    Proses Transaksi
                </button>

                <button id="clear-products-btn" class="mt-4 bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105 w-full">
                    Bersihkan Semua Produk
                </button>
            </section>
        </main>
    </div>

    <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div id="payment-summary-content" class="bg-gray-50 p-6 rounded-lg shadow-lg w-full max-w-md mx-auto relative transform transition-all sm:my-8 sm:align-middle sm:max-w-lg">
            <button id="close-payment-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Ringkasan Pembayaran</h3>

            <div class="mb-4">
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <span class="text-gray-700">Subtotal:</span>
                    <span class="font-bold text-lg text-gray-900" id="subtotal">Rp 0</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <span class="text-gray-700">Diskon:</span>
                    <input type="number" id="discount-input" value="0" min="0" class="w-24 px-2 py-1 border border-gray-300 rounded-md text-sm text-right focus:outline-none focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="flex justify-between items-center py-2 mt-2">
                    <span class="text-gray-800 text-xl font-semibold">Total:</span>
                    <span class="font-bold text-green-700 text-3xl" id="grand-total">Rp 0</span>
                </div>
            </div>

            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <label for="payment-method-select" class="block text-sm font-medium text-gray-700 mb-1">Metode Pembayaran:</label>
                <select id="payment-method-select" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                    <option value="Tunai">Tunai</option>
                    <option value="Kartu Debit">Kartu Debit</option>
                    <option value="Transfer Bank">Transfer Bank</option>
                    <option value="QRIS">QRIS</option>
                </option></select>
            </div>

            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <label for="amount-received" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Diterima (Rp):</label>
                <input type="number" id="amount-received" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Masukkan jumlah uang">
                <div class="flex justify-between items-center py-2 mt-4">
                    <span class="text-gray-700">Kembalian:</span>
                    <span class="font-bold text-lg text-blue-600" id="change">Rp 0</span>
                </div>
            </div>

            <button id="process-transaction-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-3 rounded-lg font-semibold text-lg transition duration-200 shadow-md hover:scale-105 w-full">
                Proses Transaksi
            </button>
            <div id="message-box" class="mt-4 p-3 bg-yellow-100 border border-yellow-200 text-yellow-800 rounded-md hidden"></div>
        </div>
    </div>

    <div id="transaction-history-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-50 p-6 rounded-lg shadow-lg w-full max-w-2xl mx-auto relative transform transition-all sm:my-8 sm:align-middle">
            <button id="close-transaction-history-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Riwayat Transaksi</h3>

            <div class="mb-4 p-4 border border-gray-200 rounded-lg bg-white shadow-sm flex flex-col sm:flex-row items-center gap-4">
                <label for="transaction-date-filter" class="text-gray-700 text-sm font-medium">Filter Tanggal:</label>
                <input type="date" id="transaction-date-filter"
                    class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                <button id="apply-transaction-filter-btn"
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105">
                    Cari
                </button>
                <button id="clear-transaction-filter-btn"
                        class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105">
                    Bersihkan Filter
                </button>
            </div>

            <div class="overflow-x-auto mb-4" style="max-height: 400px;">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Transaksi</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Metode Pembayaran</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-history-items" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
                <div id="empty-history-message" class="text-center text-gray-500 mt-4 hidden">Tidak ada riwayat transaksi.</div>
            </div>
        </div>
    </div>

    <div id="user-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-50 p-6 rounded-lg shadow-lg w-full max-w-xl mx-auto relative transform transition-all sm:my-8 sm:align-middle">
            <button id="close-user-settings-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Pengaturan Pengguna</h3>

            <div class="mb-4 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h4 class="text-lg font-semibold text-gray-800 mb-3">Tambah Pengguna Baru</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                    <div>
                        <label for="new-username" class="block text-gray-700 text-sm font-medium mb-1">Nama Pengguna:</label>
                        <input type="text" id="new-username" placeholder="Nama pengguna"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="new-password" class="block text-gray-700 text-sm font-medium mb-1">Kata Sandi:</label>
                        <input type="password" id="new-password" placeholder="Kata sandi (min 3 karakter)"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="new-user-role" class="block text-gray-700 text-sm font-medium mb-1">Hak Akses:</label>
                        <select id="new-user-role" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                            <option value="kasir">Kasir</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>
                <button id="add-user-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105 w-full">
                    Tambah Pengguna
                </button>
                <div id="user-settings-message-box" class="mt-4 p-3 bg-yellow-100 border border-yellow-200 text-yellow-800 rounded-md hidden"></div>
            </div>

            <h4 class="text-lg font-semibold text-gray-800 mb-3 mt-6">Daftar Pengguna</h4>
            <div class="overflow-x-auto" style="max-height: 300px;">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Pengguna</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hak Akses</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="user-list-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="3" class="text-center py-4 text-gray-500">Memuat pengguna...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="price-calculator-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-50 p-6 rounded-lg shadow-lg w-full max-w-md mx-auto relative transform transition-all sm:my-8 sm:align-middle">
            <button id="close-price-calculator-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Kalkulator Harga Jual</h3>

            <div class="mb-4">
                <label for="product-code-calc" class="block text-gray-700 text-sm font-medium mb-1">Kode Barang:</label>
                <input type="text" id="product-code-calc" placeholder="Opsional"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
            </div>
            <div class="mb-4">
                <label for="product-name-calc" class="block text-gray-700 text-sm font-medium mb-1">Nama Barang:</label>
                <input type="text" id="product-name-calc" placeholder="Nama produk"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
            </div>
            <div class="mb-4">
                <label for="modal-price-calc" class="block text-gray-700 text-sm font-medium mb-1">Modal (Rp):</label>
                <input type="number" id="modal-price-calc" placeholder="Harga modal" min="0"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
            </div>
            <div class="mb-6">
                <label for="margin-percent-calc" class="block text-gray-700 text-sm font-medium mb-1">Margin (%):</label>
                <input type="number" id="margin-percent-calc" placeholder="Persentase margin (e.g., 20)" min="0"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
            </div>

            <button id="calculate-sell-price-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg font-semibold transition duration-200 shadow-md hover:scale-105 w-full mb-4">
                Hitung Harga Jual dan Keuntungan
            </button>

            <div class="p-4 border border-gray-200 rounded-lg bg-white shadow-sm text-center mb-4">
                <p class="text-gray-700 text-md mb-2">Harga Jual:</p>
                <p id="calculated-sell-price-display" class="font-bold text-green-700 text-3xl">Rp 0</p>
            </div>
            <div class="p-4 border border-gray-200 rounded-lg bg-white shadow-sm text-center">
                <p class="text-gray-700 text-md mb-2">Keuntungan:</p>
                <p id="calculated-profit-display" class="font-bold text-blue-700 text-3xl">Rp 0</p>
            </div>

            <div id="price-calculator-message-box" class="mt-4 p-3 bg-yellow-100 border border-yellow-200 text-yellow-800 rounded-md hidden"></div>
        </div>
    </div>

</body>
</html>
